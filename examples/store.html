<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Store Showcase</title>
  <meta name="description" content="Modern store layout with product grid, carousels and cart." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --font-sans:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      --color-bg:#0f172a; /* dark default aesthetic */
      --color-surface:#1e293b;
      --color-surface-alt:#243552;
      --color-border:#334861;
      --color-border-strong:#48607d;
      --color-text:#f1f5f9;
      --color-text-dim:#93a6bd;
      --color-accent:#6366f1;
      --color-accent-accent:#818cf8;
      --color-danger:#ef4444;
      --color-success:#16a34a;
      --radius-xs:4px; --radius-sm:6px; --radius:14px; --radius-pill:999px;
      --shadow-sm:0 2px 4px -2px rgba(0,0,0,.4),0 4px 6px -1px rgba(0,0,0,.35);
      --shadow-lg:0 10px 25px -5px rgba(0,0,0,.5),0 8px 10px -6px rgba(0,0,0,.45);
      --gradient-accent:linear-gradient(135deg,var(--color-accent),var(--color-accent-accent));
      --transition:.22s cubic-bezier(.4,0,.2,1);
    }
    [data-theme=light]{
      --color-bg:#f5f7fb;
      --color-surface:#ffffff;
      --color-surface-alt:#f1f4fa;
      --color-border:#d3dbe5;
      --color-border-strong:#b3c0d2;
      --color-text:#162230;
      --color-text-dim:#5c6e84;
      --color-accent:#4f46e5;
      --color-accent-accent:#6366f1;
      --shadow-sm:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.05);
      --shadow-lg:0 15px 38px -10px rgba(0,0,0,.18),0 8px 18px -8px rgba(0,0,0,.12);
    }
    * { box-sizing:border-box; }
    body { margin:0; font-family:var(--font-sans); background:var(--color-bg); color:var(--color-text); -webkit-font-smoothing:antialiased; }
    h1,h2,h3 { line-height:1.15; letter-spacing:.4px; }
  h1 { font-size:clamp(1.9rem,3.8vw,2.6rem); margin:0; background:linear-gradient(90deg,var(--color-accent),var(--color-accent-accent)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    h2 { font-size:1.25rem; margin:0 0 1rem; }
    a { color:var(--color-accent); text-decoration:none; }
    a:hover { text-decoration:underline; }

    header { position:sticky; top:0; z-index:50; display:flex; align-items:center; gap:1.2rem; padding:.85rem clamp(1rem,3vw,2.2rem); background:rgba(30,41,59,.9); backdrop-filter:blur(18px); border-bottom:1px solid var(--color-border); box-shadow:var(--shadow-sm); }
    [data-theme=light] header { background:rgba(255,255,255,.85); }
    .brand { display:flex; align-items:center; gap:.75rem; font-weight:600; letter-spacing:.5px; }
    .brand-badge { background:var(--gradient-accent); color:#fff; padding:.45rem .7rem; border-radius:12px; font-size:.6rem; letter-spacing:1px; font-weight:600; box-shadow:0 0 0 4px rgba(99,102,241,.25); }
    nav.primary { margin-left:auto; display:flex; gap:.2rem; }
    nav.primary a, nav.primary button { font:inherit; font-size:.68rem; text-transform:uppercase; letter-spacing:.75px; font-weight:600; padding:.7rem .95rem; color:var(--color-text-dim); background:transparent; border:1px solid transparent; border-radius:var(--radius-pill); position:relative; cursor:pointer; }
    nav.primary a:hover, nav.primary button:hover, nav.primary a.active { color:var(--color-text); background:var(--color-surface-alt); }
    nav.primary button#cartBtn { display:inline-flex; align-items:center; gap:.5rem; }
    nav.primary button#cartBtn span.count { background:var(--gradient-accent); color:#fff; font-size:.55rem; padding:.2rem .45rem; border-radius:12px; min-width:18px; text-align:center; line-height:1; box-shadow:0 0 0 3px rgba(99,102,241,.3); }
  .pulse { animation:pulse-scale .6s ease; }
  @keyframes pulse-scale { 0%{ transform:scale(1);} 40%{ transform:scale(1.18);} 70%{ transform:scale(.94);} 100%{ transform:scale(1);} }

    .layout { display:grid; grid-template-columns:260px 1fr; max-width:1680px; margin:0 auto; padding:1.8rem clamp(1rem,2.4vw,2.3rem) 4rem; gap:2.2rem; }
    .sidebar { position:sticky; top:5.4rem; align-self:start; display:flex; flex-direction:column; gap:1.2rem; }
    .sidebar-header { display:none; align-items:center; justify-content:space-between; gap:1rem; padding:0 .2rem .3rem; }
    .close-filters { background:transparent; border:1px solid var(--color-border); color:var(--color-text-dim); font:inherit; font-size:.9rem; width:34px; height:34px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .close-filters:hover { color:var(--color-text); background:var(--color-surface-alt); }
    .filters-toggle { background:var(--color-surface-alt); border:1px solid var(--color-border); color:var(--color-text-dim); font:inherit; font-size:.65rem; font-weight:600; letter-spacing:.8px; padding:.55rem .9rem; border-radius:var(--radius-pill); cursor:pointer; display:inline-flex; align-items:center; gap:.4rem; }
    .filters-toggle[aria-expanded="true"] { background:var(--gradient-accent); border-color:var(--color-accent); color:#fff; box-shadow:0 0 0 3px rgba(99,102,241,.3); }
    .filters-toggle:focus-visible { outline:2px solid var(--color-accent); outline-offset:2px; }
    /* Offcanvas / collapsible behavior */
    @media (max-width:940px){
      .layout { grid-template-columns:1fr; }
      .sidebar { position:fixed; top:0; left:0; bottom:0; width:300px; max-width:85%; background:var(--color-surface); padding:1.1rem 1rem 2rem; overflow:auto; box-shadow:0 0 0 1px var(--color-border), 8px 0 28px -6px rgba(0,0,0,.55); transform:translateX(-105%); transition:transform .45s var(--transition); z-index:1300; border-right:1px solid var(--color-border); }
      .sidebar[aria-hidden="false"] { transform:translateX(0); }
      .sidebar-header { display:flex; }
      body.filters-open { overflow:hidden; }
      .filters-overlay { position:fixed; inset:0; background:rgba(15,23,42,.55); backdrop-filter:blur(6px); opacity:0; pointer-events:none; transition:opacity .35s var(--transition); z-index:1200; }
      .filters-overlay.show { opacity:1; pointer-events:auto; }
    }
    /* Narrow desktop collapsible (optional) */
    @media (min-width:941px){
      .sidebar.collapsed { width:0; padding:0; margin:0; opacity:0; pointer-events:none; }
    }
    .filter-group { background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1rem 1rem 1.2rem; box-shadow:var(--shadow-sm); }
    .filter-group h3 { margin:0 0 .9rem; font-size:.72rem; font-weight:600; letter-spacing:.75px; text-transform:uppercase; color:var(--color-text-dim); }
    .filter-group label { display:flex; align-items:center; gap:.55rem; font-size:.75rem; cursor:pointer; padding:.3rem .35rem; border-radius:8px; }
    .filter-group label:hover { background:var(--color-surface-alt); }
    .filter-group input { accent-color:var(--color-accent); }

  .product-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:1.5rem; }
  /* Multi-row independent carousels (8 item chunks, 4 visible window) */
  .gridwall-rows { display:flex; flex-direction:column; gap:0; }
  .row-carousel { position:relative; background:linear-gradient(145deg,var(--color-surface),var(--color-surface-alt)); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.2rem 1.3rem 1.55rem; box-shadow:var(--shadow-sm); }
  .row-viewport { overflow:hidden; }
  .row-track { display:flex; gap:1.2rem; transition:transform .55s var(--transition); }
  .row-track .product-card { flex:0 0 calc((100% - 3*1.2rem)/4); max-width:calc((100% - 3*1.2rem)/4); }
  @media (max-width:1000px){ .row-track .product-card { flex:0 0 calc((100% - 2*1rem)/3); max-width:calc((100% - 2*1rem)/3); } .row-track { gap:1rem; } }
  @media (max-width:760px){ .row-track .product-card { flex:0 0 calc((100% - 1*0.9rem)/2); max-width:calc((100% - 1*0.9rem)/2); } .row-track { gap:.9rem; } }
  @media (max-width:480px){ .row-track .product-card { flex:0 0 100%; max-width:100%; } }
  .row-nav { position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between; pointer-events:none; }
  .row-nav button { pointer-events:auto; background:rgba(0,0,0,.55); border:none; width:46px; height:46px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; cursor:pointer; backdrop-filter:blur(5px); box-shadow:0 4px 14px -4px rgba(0,0,0,.55); transition:var(--transition); }
  [data-theme=light] .row-nav button { background:rgba(0,0,0,.42); }
  .row-nav button:hover { background:rgba(0,0,0,.8); }
  .row-nav button:disabled { opacity:.3; cursor:not-allowed; }
  .row-status { text-align:right; margin-top:.85rem; font-size:.6rem; letter-spacing:.5px; color:var(--color-text-dim); }
  body.mode-list .row-nav, body.mode-list .row-status { display:none; }
  /* View toggle + modes */
  .view-toggle { display:flex; gap:.55rem; margin:0 0 1rem; }
  .view-toggle button { background:var(--color-surface-alt); border:1px solid var(--color-border); color:var(--color-text-dim); padding:.55rem .9rem; border-radius:var(--radius-pill); font:inherit; font-size:.65rem; font-weight:600; letter-spacing:.8px; cursor:pointer; display:inline-flex; align-items:center; gap:.35rem; }
  .view-toggle button[aria-pressed="true"] { background:var(--gradient-accent); border-color:var(--color-accent); color:#fff; box-shadow:0 0 0 3px rgba(99,102,241,.35); }
  .view-toggle button:focus-visible { outline:2px solid var(--color-accent); outline-offset:2px; }
  body.mode-grid .product-card { aspect-ratio:1/1; padding:0; position:relative; }
  body.mode-grid .product-card .media-carousel { position:absolute; inset:0; aspect-ratio:auto; height:100%; }
  body.mode-grid .product-card .media-track { height:100%; }
  body.mode-grid .product-card .media-slide img { object-fit:cover; }
  body.mode-grid .product-card .info-overlay { position:absolute; left:0; right:0; bottom:0; padding:.75rem .85rem 1rem; background:linear-gradient(to top,rgba(0,0,0,.8),rgba(0,0,0,.4),rgba(0,0,0,.05)); color:#fff; display:flex; flex-direction:column; gap:.55rem; font-size:.75rem; backdrop-filter:blur(4px); }
  [data-theme=light] body.mode-grid .product-card .info-overlay { background:linear-gradient(to top,rgba(0,0,0,.72),rgba(0,0,0,.35),rgba(0,0,0,.05)); }
  body.mode-grid .product-card h3 { font-size:.85rem; margin:0; }
  body.mode-grid .product-card .tag-row { gap:.3rem; }
  body.mode-grid .product-card .tag { background:rgba(255,255,255,.15); color:#fff; border-color:rgba(255,255,255,.25); }
  body.mode-grid .product-card button.add-btn { font-size:.55rem; padding:.5rem .7rem; align-self:flex-start; }
  /* List view rows */
  body.mode-list .row-carousel { padding:0; background:transparent; border:none; box-shadow:none; }
  .product-list { display:flex; flex-direction:column; gap:1rem; }
  .product-row { display:grid; grid-template-columns:210px 1fr auto; gap:1.25rem; background:linear-gradient(145deg,var(--color-surface),var(--color-surface-alt)); border:1px solid var(--color-border); border-radius:var(--radius); padding:1rem 1.25rem; box-shadow:var(--shadow-sm); align-items:flex-start; }
  .product-row .media-carousel { aspect-ratio:1/1; position:relative; inset:auto; height:auto; }
  .product-row h3 { margin:.1rem 0 .4rem; font-size:1rem; }
  .row-meta { display:flex; flex-wrap:wrap; gap:.8rem; font-size:.65rem; letter-spacing:.8px; text-transform:uppercase; color:var(--color-text-dim); }
  .row-tags { display:flex; flex-wrap:wrap; gap:.4rem; }
  .row-tags .tag { font-size:.55rem; }
  .row-right { display:flex; flex-direction:column; align-items:flex-end; gap:.75rem; min-width:150px; }
  .row-right .price-row { font-size:.9rem; }
  .row-right button.add-btn { width:100%; }
  @media (max-width:1050px){ .product-row { grid-template-columns:180px 1fr auto; } }
  @media (max-width:820px){ .product-row { grid-template-columns:160px 1fr; } .row-right { grid-column:1 / -1; flex-direction:row; justify-content:space-between; align-items:center; width:100%; } }
    .product-card { position:relative; background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:.9rem .9rem 1.15rem; display:flex; flex-direction:column; gap:.75rem; box-shadow:var(--shadow-sm); overflow:hidden; }
    .product-card:hover { box-shadow:var(--shadow-lg); border-color:var(--color-border-strong); }
    .media-carousel { position:relative; overflow:hidden; border-radius:12px; aspect-ratio:4/3; background:var(--color-surface-alt); }
    .media-track { display:flex; height:100%; transition:transform .6s var(--transition); }
    .media-slide { min-width:100%; position:relative; display:flex; align-items:center; justify-content:center; }
    .media-slide img { width:100%; height:100%; object-fit:cover; display:block; }
    .carousel-nav { position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between; pointer-events:none; }
    .carousel-nav button { pointer-events:auto; background:rgba(0,0,0,.45); border:none; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; cursor:pointer; backdrop-filter:blur(4px); transition:var(--transition); font-size:.9rem; }
    .carousel-nav button:hover { background:rgba(0,0,0,.7); }
    [data-theme=light] .carousel-nav button { background:rgba(0,0,0,.35); }
    .price-row { display:flex; align-items:center; gap:.6rem; font-size:.85rem; }
    .price-row .price { font-weight:600; font-size:.95rem; }
    .price-row .orig { text-decoration:line-through; opacity:.5; font-size:.7rem; }
    .tag-row { display:flex; flex-wrap:wrap; gap:.4rem; }
    .tag { font-size:.55rem; text-transform:uppercase; letter-spacing:.8px; background:var(--color-surface-alt); padding:.35rem .55rem; border-radius:var(--radius-pill); font-weight:600; color:var(--color-text-dim); border:1px solid var(--color-border); }
    .product-card h3 { margin:0; font-size:.82rem; letter-spacing:.4px; line-height:1.2; font-weight:600; }

    button.add-btn { font:inherit; font-size:.62rem; text-transform:uppercase; letter-spacing:.8px; background:var(--gradient-accent); color:#fff; padding:.65rem .85rem; border:none; border-radius:var(--radius-sm); font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:.5rem; box-shadow:var(--shadow-sm); }
    button.add-btn:hover { filter:brightness(1.1); }
    button.add-btn:active { transform:translateY(1px); }

    .empty-msg { font-size:.75rem; opacity:.7; padding:2rem 0; text-align:center; grid-column:1/-1; }

    /* Cart Drawer */
    .cart-drawer { position:fixed; top:0; right:0; bottom:0; width:380px; max-width:100%; background:var(--color-surface); border-left:1px solid var(--color-border); box-shadow: -4px 0 16px -2px rgba(0,0,0,.4); transform:translateX(105%); transition:transform .45s var(--transition); display:flex; flex-direction:column; z-index:1200; }
    .cart-drawer.open { transform:translateX(0); }
    .cart-header { display:flex; align-items:center; justify-content:space-between; padding:1rem 1.1rem; border-bottom:1px solid var(--color-border); }
    .cart-header h2 { font-size:1rem; margin:0; }
    .cart-body { flex:1; overflow:auto; padding:1rem .9rem 1.5rem; display:flex; flex-direction:column; gap:1rem; }
    .cart-item { display:grid; grid-template-columns:64px 1fr auto; gap:.75rem; background:var(--color-surface-alt); padding:.65rem .65rem .65rem .65rem; border:1px solid var(--color-border); border-radius:10px; position:relative; }
    .cart-item img { width:64px; height:64px; object-fit:cover; border-radius:8px; }
    .cart-item h3 { margin:0 0 .25rem; font-size:.72rem; font-weight:600; }
    .qty { display:inline-flex; align-items:center; gap:.35rem; background:var(--color-surface); border:1px solid var(--color-border); border-radius:8px; padding:.3rem .45rem; font-size:.65rem; }
    .qty button { background:transparent; border:none; color:var(--color-text); cursor:pointer; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
    .qty button:disabled { opacity:.3; cursor:not-allowed; }
    .line-total { font-size:.7rem; font-weight:600; margin-top:.35rem; color:var(--color-text-dim); }
    .remove-btn { position:absolute; top:4px; right:4px; background:transparent; border:none; color:var(--color-text-dim); cursor:pointer; font-size:.9rem; }
    .remove-btn:hover { color:var(--color-danger); }
    .cart-footer { border-top:1px solid var(--color-border); padding:1rem 1.1rem 1.4rem; display:flex; flex-direction:column; gap:.9rem; background:var(--color-surface-alt); }
    .totals { display:grid; grid-template-columns:1fr auto; row-gap:.4rem; font-size:.7rem; }
    .totals strong { font-size:.75rem; }
    .checkout-btn { background:var(--gradient-accent); border:none; color:#fff; font:inherit; font-size:.7rem; letter-spacing:.8px; font-weight:600; padding:.85rem 1rem; border-radius:var(--radius-sm); cursor:pointer; text-transform:uppercase; }
    .checkout-btn:hover { filter:brightness(1.1); }

    .overlay { position:fixed; inset:0; background:rgba(15,23,42,.55); backdrop-filter:blur(6px); opacity:0; pointer-events:none; transition:opacity .35s var(--transition); z-index:1100; }
    .overlay.show { opacity:1; pointer-events:auto; }

    /* Theme toggle */
    #themeToggle { background:var(--color-surface-alt); border:1px solid var(--color-border); color:var(--color-text-dim); font:inherit; font-size:.65rem; font-weight:600; letter-spacing:.7px; padding:.6rem .85rem; border-radius:var(--radius-pill); cursor:pointer; }
    #themeToggle:hover { color:var(--color-text); }

    /* Responsive */
    @media (max-width:1100px){ .layout { grid-template-columns:220px 1fr; padding:1.4rem 1.2rem 4rem; } }
    @media (max-width:940px){ .layout { grid-template-columns:1fr; padding:1.2rem 1rem 4.2rem; } .sidebar { position:static; flex-direction:row; overflow:auto; padding-bottom:.6rem; }
      .sidebar::-webkit-scrollbar{ height:8px; }
      .filter-group { min-width:200px; }
    }
    @media (max-width:620px){ nav.primary { gap:.4rem; } nav.primary a, nav.primary button { padding:.55rem .75rem; } h1 { font-size:1.9rem; } .product-grid { gap:1.1rem; } }
    @media (max-width:480px){ header { padding:.8rem .9rem; } .product-card { padding:.75rem .75rem 1rem; } .cart-drawer { width:100%; } }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <span class="brand-badge">Shop</span>
    <strong>Store Showcase</strong>
  </div>
  <nav class="primary" aria-label="Primary navigation">
    <a href="../index.html">Index</a>
    <a href="elements.html">Elements</a>
    <a href="orderform.html">Order Form</a>
    <button id="cartBtn" type="button" aria-haspopup="dialog" aria-expanded="false">Cart <span class="count" id="cartCount">0</span></button>
    <button id="themeToggle" type="button" aria-pressed="false">Theme</button>
  </nav>
</header>
<main class="layout">
  <aside class="sidebar" aria-label="Filters" id="filtersPane" aria-hidden="false">
    <div class="sidebar-header"><h2 style="margin:0;font-size:.8rem;letter-spacing:.8px;text-transform:uppercase;color:var(--color-text-dim);">Filters</h2><button type="button" class="close-filters" aria-label="Close filters">×</button></div>
    <div class="filter-group" id="categoryFilters">
      <h3>Categories</h3>
      <!-- dynamic category checkboxes -->
    </div>
    <div class="filter-group" id="tagFilters">
      <h3>Tags</h3>
      <!-- dynamic tag checkboxes -->
    </div>
  </aside>
  <div>
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;margin:0 0 1.2rem;">
      <h1>Featured Products</h1>
      <div style="display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;">
        <button type="button" id="filtersToggle" class="filters-toggle" aria-controls="filtersPane" aria-expanded="true">Filters</button>
        <input type="search" id="searchInput" placeholder="Search products..." aria-label="Search products" style="background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius-pill);padding:.55rem .9rem;font:inherit;font-size:.7rem;color:var(--color-text);min-width:220px;" />
        <select id="sortSelect" aria-label="Sort products" style="background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius-pill);padding:.55rem .8rem;font:inherit;font-size:.65rem;color:var(--color-text-dim);">
          <option value="featured">Featured</option>
          <option value="price-asc">Price: Low to High</option>
          <option value="price-desc">Price: High to Low</option>
          <option value="newest">Newest</option>
        </select>
      </div>
    </div>
    <div class="view-toggle" id="viewToggle" role="group" aria-label="View mode">
      <button type="button" id="btnGrid" aria-pressed="true">Grid</button>
      <button type="button" id="btnList" aria-pressed="false">List</button>
    </div>
    <div id="gridwallRows" class="gridwall-rows" aria-live="polite"></div>
    <div class="empty-msg" id="emptyMsg" hidden>No products match your filters.</div>
  </div>
</main>

<div class="overlay" id="overlay" hidden></div>
<aside class="cart-drawer" id="cartDrawer" aria-labelledby="cartTitle" aria-hidden="true" role="dialog">
  <div class="cart-header">
    <h2 id="cartTitle">Your Cart</h2>
    <button type="button" id="closeCartBtn" aria-label="Close cart" style="background:transparent;border:none;color:var(--color-text-dim);font-size:1.1rem;cursor:pointer;">×</button>
  </div>
  <div class="cart-body" id="cartBody"></div>
  <div class="cart-footer">
    <div class="totals" id="cartTotals"></div>
    <button class="checkout-btn" id="checkoutBtn">Checkout</button>
  </div>
</aside>

<footer style="text-align:center;padding:3rem 1rem 4rem;font-size:.65rem;color:var(--color-text-dim);">&copy; <span id="year"></span> Store Showcase</footer>

<script src="../theme.js" defer></script>
<script>
(function(){
  // Theme handled globally (theme.js)

  document.getElementById('year').textContent = new Date().getFullYear();

  /* Data */
  const products = [
    { id:'p1', name:'Aurora Wireless Headphones', price:149, orig:199, featured:true, created:'2025-07-12', categories:['audio'], tags:['wireless','new','premium'], media:[
      'https://images.unsplash.com/photo-1518441902117-f6f36bfae1ec?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1583394838336-acd977736f90?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p2', name:'Nebula Smart Speaker', price:89, orig:null, featured:true, created:'2025-08-02', categories:['home','audio'], tags:['assistant','compact'], media:[
      'https://images.unsplash.com/photo-1589003077984-894e133dabab?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1546435770-a3e426bf472b?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p3', name:'Polar Fitness Tracker Pro', price:129, orig:159, featured:false, created:'2025-09-01', categories:['wearables','fitness'], tags:['health','waterproof'], media:[
      'https://images.unsplash.com/photo-1516825173900-1be7c7a0fa36?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p4', name:'Solstice 4K Action Camera', price:249, orig:299, featured:true, created:'2025-06-21', categories:['cameras'], tags:['outdoor','4k','waterproof'], media:[
      'https://images.unsplash.com/photo-1508896694512-bd3e5abac110?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1544197150-b99a580bb7a8?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p5', name:'Lumen Portable Projector', price:329, orig:399, featured:false, created:'2025-08-15', categories:['home','video'], tags:['portable','hd'], media:[
      'https://images.unsplash.com/photo-1587574293340-e0011c4e8ecf?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1601935111741-ae98b2b230b0?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p6', name:'Orbit Drone Explorer', price:799, orig:899, featured:true, created:'2025-05-30', categories:['drones'], tags:['4k','stabilized','premium'], media:[
      'https://images.unsplash.com/photo-1512820790803-83ca734da794?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1523961131990-5ea7c61b2107?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p7', name:'Pulse Gaming Controller X', price:69, orig:null, featured:false, created:'2025-09-10', categories:['gaming'], tags:['ergonomic','new'], media:[
      'https://images.unsplash.com/photo-1589241062272-c0a000072dfa?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1589810264340-0ce27b6d7b9c?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p8', name:'Zen Noise-Cancel Earbuds', price:179, orig:219, featured:false, created:'2025-07-28', categories:['audio','wearables'], tags:['wireless','noise-cancel'], media:[
      'https://images.unsplash.com/photo-1603354350317-6f7aaa5911c5?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p9', name:'Vertex Mechanical Keyboard', price:139, orig:169, featured:true, created:'2025-09-15', categories:['gaming'], tags:['rgb','hot-swap','new'], media:[
      'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1555685812-4b7432b7b8a9?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p10', name:'Nimbus Smart Thermostat', price:199, orig:null, featured:false, created:'2025-08-30', categories:['home'], tags:['energy','automation'], media:[
      'https://images.unsplash.com/photo-1603354350683-5236e32b9a4d?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1601972599720-b7d1f92a6c93?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p11', name:'Aero Portable SSD 2TB', price:249, orig:279, featured:true, created:'2025-09-05', categories:['storage'], tags:['usb-c','fast'], media:[
      'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1581291518857-4e27b48ff24e?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p12', name:'Clarity 27" 5K Monitor', price:899, orig:999, featured:true, created:'2025-06-05', categories:['displays'], tags:['5k','wide-gamut','premium'], media:[
      'https://images.unsplash.com/photo-1587825140708-dfaf72ae4b01?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1587202372775-e229f172b22f?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p13', name:'Flux USB-C Hub Pro', price:89, orig:109, featured:false, created:'2025-08-09', categories:['accessories'], tags:['usb-c','dock'], media:[
      'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p14', name:'Nova Smart Light Panel Kit', price:219, orig:249, featured:false, created:'2025-07-01', categories:['home'], tags:['ambient','rgb'], media:[
      'https://images.unsplash.com/photo-1589003077984-894e133dabab?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1555685812-4b7432b7b8a9?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p15', name:'Sentinel 2TB NAS Enclosure', price:349, orig:399, featured:false, created:'2025-05-11', categories:['storage','home'], tags:['network','backup'], media:[
      'https://images.unsplash.com/photo-1581291518857-4e27b48ff24e?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1518441902117-f6f36bfae1ec?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p16', name:'Aquila VR Headset', price:499, orig:549, featured:true, created:'2025-09-12', categories:['gaming'], tags:['immersive','vr','new'], media:[
      'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1523961131990-5ea7c61b2107?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p17', name:'Pulse Pro Gaming Mouse', price:79, orig:99, featured:false, created:'2025-09-03', categories:['gaming'], tags:['ergonomic','rgb'], media:[
      'https://images.unsplash.com/photo-1555685812-4b7432b7b8a9?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1589241062272-c0a000072dfa?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p18', name:'Tempo Smart Metronome', price:59, orig:null, featured:false, created:'2025-07-19', categories:['audio'], tags:['music','portable'], media:[
      'https://images.unsplash.com/photo-1583394838336-acd977736f90?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p19', name:'Glide Wireless Charger Pad', price:39, orig:49, featured:false, created:'2025-08-23', categories:['accessories'], tags:['wireless','qi'], media:[
      'https://images.unsplash.com/photo-1603354350317-6f7aaa5911c5?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1587202372775-e229f172b22f?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p20', name:'Echo Smart Doorbell', price:129, orig:149, featured:false, created:'2025-05-28', categories:['home'], tags:['security','camera'], media:[
      'https://images.unsplash.com/photo-1601972599720-b7d1f92a6c93?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1512820790803-83ca734da794?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p21', name:'Stratus Portable Power Bank', price:59, orig:79, featured:false, created:'2025-09-06', categories:['accessories'], tags:['battery','usb-c'], media:[
      'https://images.unsplash.com/photo-1581291518857-4e27b48ff24e?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1603354350683-5236e32b9a4d?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p22', name:'Voyager Travel Adapter', price:49, orig:null, featured:false, created:'2025-07-08', categories:['accessories'], tags:['international','compact'], media:[
      'https://images.unsplash.com/photo-1587202372775-e229f172b22f?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1603354350317-6f7aaa5911c5?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p23', name:'Nimbus Smart Plug Duo', price:34, orig:44, featured:false, created:'2025-08-04', categories:['home'], tags:['automation','energy'], media:[
      'https://images.unsplash.com/photo-1589003077984-894e133dabab?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1601972599720-b7d1f92a6c93?auto=format&fit=crop&w=600&q=60'
    ]},
    { id:'p24', name:'Helix Cable Organizer', price:19, orig:null, featured:false, created:'2025-09-02', categories:['accessories'], tags:['desk','cable'], media:[
      'https://images.unsplash.com/photo-1587825140708-dfaf72ae4b01?auto=format&fit=crop&w=600&q=60',
      'https://images.unsplash.com/photo-1581291518857-4e27b48ff24e?auto=format&fit=crop&w=600&q=60'
    ]}
  ];

  /* Derived filter data */
  const categorySet = new Set();
  const tagSet = new Set();
  products.forEach(p=>{ p.categories.forEach(c=>categorySet.add(c)); p.tags.forEach(t=>tagSet.add(t)); });

  const categoryFiltersEl = document.getElementById('categoryFilters');
  const tagFiltersEl = document.getElementById('tagFilters');
  function renderFilters(){
    const catFrag = document.createDocumentFragment();
    [...categorySet].sort().forEach(c => {
      const id='cat-'+c;
      const label=document.createElement('label');
      label.innerHTML = `<input type="checkbox" value="${c}" data-filter-cat /> <span>${c}</span>`;
      catFrag.appendChild(label);
    });
    categoryFiltersEl.appendChild(catFrag);
    const tagFrag = document.createDocumentFragment();
    [...tagSet].sort().forEach(t => {
      const label=document.createElement('label');
      label.innerHTML = `<input type="checkbox" value="${t}" data-filter-tag /> <span>${t}</span>`;
      tagFrag.appendChild(label);
    });
    tagFiltersEl.appendChild(tagFrag);
  }
  renderFilters();

  const gridwallRows = document.getElementById('gridwallRows');
  const ROW_SIZE = 8; // chunk size for each independent row carousel
  const DEFAULT_SHOW = 4; // intended visible window
  const btnGrid = document.getElementById('btnGrid');
  const btnList = document.getElementById('btnList');
  const VIEW_KEY='store-view-mode';
  let viewMode = localStorage.getItem(VIEW_KEY) || 'grid';
  const emptyMsg = document.getElementById('emptyMsg');
  const searchInput = document.getElementById('searchInput');
  const sortSelect = document.getElementById('sortSelect');
  const filtersPane = document.getElementById('filtersPane');
  const filtersToggle = document.getElementById('filtersToggle');
  const closeFiltersBtn = document.querySelector('.close-filters');
  let filtersOpen = true; // desktop default
  // Create overlay for filters (mobile) separate from cart overlay to avoid conflicts
  let filtersOverlay = document.querySelector('.filters-overlay');
  if(!filtersOverlay){
    filtersOverlay = document.createElement('div');
    filtersOverlay.className='filters-overlay';
    document.body.appendChild(filtersOverlay);
  }

  function isMobileFilters(){ return window.matchMedia('(max-width:940px)').matches; }
  function openFilters(){
    filtersOpen = true;
    filtersPane.setAttribute('aria-hidden','false');
    filtersToggle.setAttribute('aria-expanded','true');
    if(isMobileFilters()){
      document.body.classList.add('filters-open');
      filtersOverlay.classList.add('show');
      // focus first interactive element inside
      const first = filtersPane.querySelector('input,button,select');
      if(first) first.focus();
    }
  }
  function closeFilters(){
    filtersOpen = false;
    filtersPane.setAttribute('aria-hidden','true');
    filtersToggle.setAttribute('aria-expanded','false');
    if(isMobileFilters()){
      filtersOverlay.classList.remove('show');
      document.body.classList.remove('filters-open');
      filtersToggle.focus();
    }
  }
  function toggleFilters(){ filtersOpen ? closeFilters() : openFilters(); }
  filtersToggle.addEventListener('click', toggleFilters);
  closeFiltersBtn.addEventListener('click', closeFilters);
  filtersOverlay.addEventListener('click', closeFilters);
  window.addEventListener('keydown', e => { if(e.key==='Escape'){ if(filtersOpen && isMobileFilters()) closeFilters(); }});
  // Adjust state on resize
  window.addEventListener('resize', () => {
    if(isMobileFilters()){
      if(!filtersOpen){ filtersPane.setAttribute('aria-hidden','true'); }
    } else {
      // desktop -> always visible logically but we allow collapse memory
      filtersPane.setAttribute('aria-hidden', filtersOpen? 'false':'true');
    }
  });
  // Initialize correct state for first load
  if(isMobileFilters()) { closeFilters(); } else { openFilters(); }

  function formatCurrency(v){ return '$'+v.toFixed(2); }

  function productCardHTML(p){
    const slides = p.media.map((m,i)=>`<div class=\"media-slide\" data-index=\"${i}\"><img src=\"${m}\" alt=\"${p.name} image ${i+1}\"></div>`).join('');
    const tags = p.tags.slice(0,3).map(t=>`<span class=\"tag\">${t}</span>`).join('');
    return `<article class=\"product-card\" data-id=\"${p.id}\" data-name=\"${p.name.toLowerCase()}\" data-price=\"${p.price}\" data-created=\"${p.created}\" aria-labelledby=\"ttl-${p.id}\">\n      <div class=\"media-carousel\" data-carousel><div class=\"media-track\">${slides}</div><div class=\"carousel-nav\"><button type=button data-prev aria-label=\"Previous image\">◂</button><button type=button data-next aria-label=\"Next image\">▸</button></div></div>\n      <div class=\"info-overlay\">\n        <h3 id=\"ttl-${p.id}\">${p.name}</h3>\n        <div class=\"price-row\"> <span class=\"price\">${formatCurrency(p.price)}</span>${p.orig?`<span class=\"orig\">${formatCurrency(p.orig)}</span>`:''}</div>\n        <div class=\"tag-row\">${tags}</div>\n        <button class=\"add-btn\" data-add type=\"button\">Add</button>\n      </div>\n    </article>`;
  }
  function productRowHTML(p){
    const slides = p.media.map((m,i)=>`<div class=\"media-slide\" data-index=\"${i}\"><img src=\"${m}\" alt=\"${p.name} image ${i+1}\"></div>`).join('');
    const tags = p.tags.map(t=>`<span class=\"tag\">${t}</span>`).join('');
    return `<article class=\"product-row\" data-id=\"${p.id}\" aria-labelledby=\"row-${p.id}\">\n      <div class=\"media-carousel\" data-carousel><div class=\"media-track\">${slides}</div><div class=\"carousel-nav\"><button type=button data-prev aria-label=\"Previous image\">◂</button><button type=button data-next aria-label=\"Next image\">▸</button></div></div>\n      <div>\n        <h3 id=\"row-${p.id}\">${p.name}</h3>\n        <div class=\"row-meta\">${p.categories.join(', ')}${p.featured?' • Featured':''}</div>\n        <div class=\"row-tags\">${tags}</div>\n      </div>\n      <div class=\"row-right\">\n        <div class=\"price-row\"><span class=\"price\">${formatCurrency(p.price)}</span>${p.orig?`<span class=\"orig\">${formatCurrency(p.orig)}</span>`:''}</div>\n        <button class=\"add-btn\" data-add type=\"button\">Add to Cart</button>\n      </div>\n    </article>`;
  }

  function sortProducts(list){
    const mode = sortSelect.value;
    switch(mode){
      case 'price-asc': return list.sort((a,b)=>a.price-b.price);
      case 'price-desc': return list.sort((a,b)=>b.price-a.price);
      case 'newest': return list.sort((a,b)=> new Date(b.created)-new Date(a.created));
      default: return list.sort((a,b)=> (b.featured?1:0)-(a.featured?1:0));
    }
  }

  function activeFilters(){
    const cats=[...document.querySelectorAll('[data-filter-cat]:checked')].map(i=>i.value);
    const tags=[...document.querySelectorAll('[data-filter-tag]:checked')].map(i=>i.value);
    return { cats, tags };
  }

  function matchesFilters(p,{cats,tags}){
    const catOk = !cats.length || cats.some(c=>p.categories.includes(c));
    const tagOk = !tags.length || tags.some(t=>p.tags.includes(t));
    return catOk && tagOk;
  }

  function chunkRows(list){ const rows=[]; for(let i=0;i<list.length;i+=ROW_SIZE){ rows.push(list.slice(i,i+ROW_SIZE)); } return rows; }
  function initRowCarousel(section){
    const track = section.querySelector('.row-track');
    const viewport = section.querySelector('.row-viewport');
    const cards = [...track.children];
    const prev = section.querySelector('[data-prev-row]');
    const next = section.querySelector('[data-next-row]');
    const status = section.querySelector('.row-status');
    let index=0;
    function visible(){
      const first = cards[0]; if(!first) return DEFAULT_SHOW;
      const vw = viewport.clientWidth; const cw = first.clientWidth; if(!cw) return DEFAULT_SHOW;
      return Math.max(1, Math.round(vw / cw));
    }
    function maxIndex(){ return Math.max(0, cards.length - visible()); }
    function update(){
      const vis = visible(); if(index>maxIndex()) index=maxIndex();
      const shiftPct = (index * (100/vis));
      track.style.transform = `translateX(-${shiftPct}%)`;
      prev.disabled = index===0; next.disabled = index===maxIndex();
      if(cards.length>vis){ const end = Math.min(cards.length, index+vis); status.textContent = `Showing ${index+1}-${end} of ${cards.length}`; } else { status.textContent=''; }
      if(cards.length<=vis){ prev.style.display='none'; next.style.display='none'; status.textContent=''; }
    }
    const STEP = 2; // move two items per navigation action
    function step(delta){
      const vis = visible();
      const newIndex = Math.min(maxIndex(), Math.max(0, index + delta*STEP));
      if(newIndex!==index){ index = newIndex; update(); }
    }
    prev.addEventListener('click', ()=> step(-1));
    next.addEventListener('click', ()=> step(1));
    section.addEventListener('keydown', e => { if(e.key==='ArrowRight'){ step(1); } else if(e.key==='ArrowLeft'){ step(-1); } });
    window.addEventListener('resize', update);
    update();
  }
  function renderProducts(){
    const term = searchInput.value.trim().toLowerCase();
    const filters = activeFilters();
    let list = products.filter(p => (!term || p.name.toLowerCase().includes(term)) && matchesFilters(p, filters));
    list = sortProducts(list);
    document.body.classList.toggle('mode-grid', viewMode==='grid');
    document.body.classList.toggle('mode-list', viewMode==='list');
    if(viewMode==='grid'){
      const rows = chunkRows(list);
  gridwallRows.innerHTML = rows.map((row,i)=>`<section class=\"row-carousel\" data-row tabindex=\"0\" aria-roledescription=\"carousel\" aria-label=\"Products row ${i+1}\">\n  <div class=\"row-viewport\">\n    <div class=\"row-track\">${row.map(productCardHTML).join('')}<\/div>\n    <div class=\"row-nav\"><button type=\"button\" data-prev-row aria-label=\"Previous items\">◂<\/button><button type=\"button\" data-next-row aria-label=\"Next items\">▸<\/button><\/div>\n  <\/div>\n  <div class=\"row-status\" aria-live=\"polite\"></div>\n<\/section>`).join('');
    } else {
      gridwallRows.innerHTML = `<div class=\"product-list\">${list.map(productRowHTML).join('')}</div>`;
    }
    emptyMsg.hidden = list.length>0;
  initMiniCarousels();
  if(viewMode==='grid'){ gridwallRows.querySelectorAll('[data-row]').forEach(initRowCarousel); }
  }
  function syncViewButtons(){
    btnGrid.setAttribute('aria-pressed', viewMode==='grid');
    btnList.setAttribute('aria-pressed', viewMode==='list');
  }
  btnGrid.addEventListener('click', ()=> { if(viewMode!=='grid'){ viewMode='grid'; localStorage.setItem(VIEW_KEY, viewMode); renderProducts(); syncViewButtons(); }});
  btnList.addEventListener('click', ()=> { if(viewMode!=='list'){ viewMode='list'; localStorage.setItem(VIEW_KEY, viewMode); renderProducts(); syncViewButtons(); }});

  document.addEventListener('change', e => {
    if(e.target.matches('[data-filter-cat], [data-filter-tag]')) renderProducts();
  });
  // Filters remain reactive even while pane hidden on mobile.
  searchInput.addEventListener('input', () => { renderProducts(); });
  sortSelect.addEventListener('change', () => { renderProducts(); });

  /* Mini carousels */
  function initMiniCarousels(){
    document.querySelectorAll('[data-carousel]').forEach(car => {
      const track = car.querySelector('.media-track');
      const slides = [...car.querySelectorAll('.media-slide')];
      let index = 0; const max = slides.length;
      function set(i){ index = (i+max)%max; track.style.transform = `translateX(-${index*100}%)`; }
      car.querySelector('[data-prev]').addEventListener('click', () => set(index-1));
      car.querySelector('[data-next]').addEventListener('click', () => set(index+1));
    });
  }

  /* Cart */
  const CART_KEY='store-cart';
  let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
  const cartBtn = document.getElementById('cartBtn');
  const cartCount = document.getElementById('cartCount');
  const cartDrawer = document.getElementById('cartDrawer');
  const overlay = document.getElementById('overlay');
  const cartBody = document.getElementById('cartBody');
  const cartTotals = document.getElementById('cartTotals');
  const closeCartBtn = document.getElementById('closeCartBtn');

  function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
  function cartQuantity(){ return cart.reduce((s,i)=>s+i.q,0); }
  function updateCartCount(){ cartCount.textContent = cartQuantity(); }

  function lineTotal(item){ return item.q * item.price; }
  function computeTotals(){
    const subtotal = cart.reduce((s,i)=> s + lineTotal(i),0);
    const shipping = subtotal>0 ? (subtotal>500?0:12) : 0;
    const tax = subtotal * 0.08;
    const total = subtotal + shipping + tax;
    return { subtotal, shipping, tax, total };
  }
  function renderTotals(){
    const {subtotal,shipping,tax,total} = computeTotals();
    cartTotals.innerHTML = `
      <span>Subtotal</span><span>${formatCurrency(subtotal)}</span>
      <span>Shipping</span><span>${shipping?formatCurrency(shipping):'Free'}</span>
      <span>Tax (est.)</span><span>${formatCurrency(tax)}</span>
      <strong>Total</strong><strong>${formatCurrency(total)}</strong>`;
  }

  function renderCart(){
    cartBody.innerHTML = cart.map(item => `
      <div class="cart-item" data-id="${item.id}">
        <img src="${item.media[0]}" alt="${item.name} thumb" />
        <div>
          <h3>${item.name}</h3>
          <div class="qty" role="group" aria-label="Quantity selector">
            <button type="button" data-dec aria-label="Decrease quantity">−</button>
            <span aria-live="polite">${item.q}</span>
            <button type="button" data-inc aria-label="Increase quantity">+</button>
          </div>
          <div class="line-total">${formatCurrency(lineTotal(item))}</div>
        </div>
        <button class="remove-btn" type="button" aria-label="Remove item" data-remove>×</button>
      </div>`).join('');
    if(!cart.length){ cartBody.innerHTML = '<p style="font-size:.7rem;opacity:.7;">Your cart is empty.</p>'; }
    updateCartCount();
    renderTotals();
  }

  function openCart(){ cartDrawer.classList.add('open'); cartDrawer.setAttribute('aria-hidden','false'); overlay.hidden=false; overlay.classList.add('show'); cartBtn.setAttribute('aria-expanded','true'); trapFocus(cartDrawer); closeCartBtn.focus(); }
  function closeCart(){ cartDrawer.classList.remove('open'); cartDrawer.setAttribute('aria-hidden','true'); overlay.classList.remove('show'); setTimeout(()=> overlay.hidden=true, 300); cartBtn.setAttribute('aria-expanded','false'); lastFocus && lastFocus.focus(); }

  let lastFocus = null;
  cartBtn.addEventListener('click', ()=> { lastFocus=document.activeElement; if(isMobileFilters() && filtersOpen) closeFilters(); openCart(); });
  overlay.addEventListener('click', closeCart);
  closeCartBtn.addEventListener('click', closeCart);
  document.addEventListener('keydown', e => { if(e.key==='Escape' && cartDrawer.classList.contains('open')) closeCart(); });

  function trapFocus(container){
    const focusableSel = 'a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])';
    function loop(e){
      if(e.key==='Tab'){
        const items=[...container.querySelectorAll(focusableSel)].filter(el=>!el.disabled && el.offsetParent);
        if(!items.length) return;
        const first=items[0], last=items[items.length-1];
        if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
        else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
      }
    }
    container.addEventListener('keydown', loop);
  }

  gridwallRows.addEventListener('click', e => {
    if(e.target.closest('[data-add]')){
      const card = e.target.closest('.product-card');
      const id = card.dataset.id;
      const existing = cart.find(i=>i.id===id);
      if(existing){ existing.q += 1; }
      else {
        const prod = products.find(p=>p.id===id);
        cart.push({ id:prod.id, name:prod.name, price:prod.price, media:prod.media, q:1 });
      }
      saveCart();
      renderCart();
      cartBtn.classList.add('pulse');
      setTimeout(()=>cartBtn.classList.remove('pulse'),600);
    }
  });

  cartBody.addEventListener('click', e => {
    const itemEl = e.target.closest('.cart-item');
    if(!itemEl) return;
    const id = itemEl.dataset.id;
    const item = cart.find(i=>i.id===id);
    if(e.target.matches('[data-inc]')){ item.q++; }
    else if(e.target.matches('[data-dec]')){ item.q = Math.max(1, item.q-1); }
    else if(e.target.matches('[data-remove]')){ cart = cart.filter(i=>i.id!==id); }
    saveCart();
    renderCart();
  });

  document.getElementById('checkoutBtn').addEventListener('click', () => {
    if(!cart.length){ alert('Cart empty'); return; }
    alert('Checkout not implemented. Total '+computeTotals().total.toFixed(2));
  });

  /* Initial */
  syncViewButtons();
  renderProducts();
  renderCart();
})();
</script>
</body>
</html>
