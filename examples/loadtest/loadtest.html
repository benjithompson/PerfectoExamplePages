<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loadtest Data | Performance Testing</title>
  <meta name="description" content="Track and analyze URL parameters and request data for load testing" />
  <script src="./supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../themes/default.css">
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; }
    body { margin:0; font-family:var(--font-sans); background:var(--color-bg); color:var(--color-text); line-height:1.4; min-height:100vh; display:flex; flex-direction:column; }

    /* HEADER */
    header { position:sticky; top:0; z-index:50; backdrop-filter:blur(18px); background:linear-gradient(145deg,var(--color-bg-alt),var(--color-surface) 60%); border-bottom:1px solid var(--color-border); display:flex; flex-wrap:wrap; align-items:center; gap:1rem; padding:.85rem clamp(1rem,3vw,2rem); box-shadow:var(--shadow-xs); }
    .brand { font-weight:600; letter-spacing:.5px; font-size:1rem; display:flex; align-items:center; gap:.55rem; }
    header a, header button { font:inherit; cursor:pointer; border:1px solid var(--color-border); background:var(--color-surface-alt); color:var(--color-text-dim); padding:.55rem .85rem; border-radius:var(--radius-sm); display:inline-flex; align-items:center; gap:.45rem; font-size:.75rem; font-weight:600; letter-spacing:.8px; text-transform:uppercase; text-decoration:none; transition:var(--transition); }
    header a:hover, header button:hover { color:var(--color-text); border-color:var(--color-accent); }

    /* LAYOUT */
    main { flex:1; width:100%; max-width:1400px; margin:0 auto; padding:1.6rem clamp(1rem,3vw,2.4rem) 3.5rem; }
    .page-title { margin:0 0 1.5rem 0; font-size:clamp(1.9rem,3.5vw,2.8rem); line-height:1.1; letter-spacing:.5px; font-weight:600; background:linear-gradient(92deg,var(--color-text) 10%, var(--color-accent) 95%); -webkit-background-clip:text; background-clip:text; color:transparent; }

    /* STATS PANEL */
    .stats-panel { background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-lg); padding:1.5rem; box-shadow:var(--shadow-md); margin-bottom:1.5rem; }
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-bottom:1.5rem; }
    .stat-card { background:var(--color-bg-alt); border:1px solid var(--color-border); border-radius:var(--radius); padding:1rem; }
    .stat-label { font-size:.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--color-text-dim); margin-bottom:.5rem; font-weight:600; }
    .stat-value { font-size:1.8rem; font-weight:700; color:var(--color-accent); }

    /* REQUEST TABLE */
    .request-table-section { background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-lg); padding:1.5rem; box-shadow:var(--shadow-md); margin-bottom:1.5rem; }
    .request-table-section h2 { margin:0 0 1rem 0; font-size:1.3rem; font-weight:700; }
    .table-wrapper { overflow-x:auto; max-height:600px; overflow-y:auto; border:1px solid var(--color-border); border-radius:var(--radius); }
    .table-controls { display:flex; gap:1rem; margin-bottom:1rem; align-items:center; flex-wrap:wrap; }
    .search-input { padding:.5rem .75rem; border:1px solid var(--color-border); border-radius:var(--radius-sm); background:var(--color-bg); color:var(--color-text); font-size:.9rem; flex:1; min-width:200px; }
    .request-table { width:100%; border-collapse:collapse; }
    .request-table thead { background:var(--color-bg-alt); position:sticky; top:0; z-index:10; }
    .request-table th { text-align:left; padding:.75rem 1rem; font-size:.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--color-text-dim); font-weight:600; border-bottom:2px solid var(--color-border); cursor:pointer; user-select:none; }
    .request-table th:hover { background:var(--color-surface); }
    .request-table th.sortable::after { content:'‚áÖ'; margin-left:.5rem; opacity:.3; }
    .request-table th.sort-asc::after { content:'‚Üë'; opacity:1; }
    .request-table th.sort-desc::after { content:'‚Üì'; opacity:1; }
    .request-table td { padding:.75rem 1rem; border-bottom:1px solid var(--color-border); font-family:monospace; font-size:.9rem; }
    .request-table tbody tr:hover { background:var(--color-bg-alt); }
    .request-table tbody tr:last-child td { border-bottom:none; }
    .param-col { color:var(--color-accent); font-weight:600; }
    .value-col { color:var(--color-text); }
    .count-col { text-align:center; font-weight:700; color:var(--color-accent); }
    .table-empty { text-align:center; padding:2rem; color:var(--color-text-dim); font-style:italic; }

    /* CONTROLS */
    .controls { display:flex; gap:1rem; align-items:center; margin-top:1rem; flex-wrap:wrap; }
    .btn { font:inherit; cursor:pointer; border:1px solid var(--color-border); background:var(--color-surface-alt); color:var(--color-text); padding:.75rem 1.25rem; border-radius:var(--radius-sm); font-size:.85rem; font-weight:600; letter-spacing:.5px; text-transform:uppercase; transition:var(--transition); display:inline-flex; align-items:center; gap:.5rem; }
    .btn:hover { background:var(--color-accent); color:#fff; border-color:var(--color-accent); }
    .btn-danger { background:#e74c3c; color:#fff; border-color:#e74c3c; }
    .btn-danger:hover { background:#c0392b; border-color:#c0392b; }
    .btn-success { background:#27ae60; color:#fff; border-color:#27ae60; }
    .btn-success:hover { background:#229954; border-color:#229954; }

    @media (max-width:768px) {
      .stats-grid { grid-template-columns:1fr; }
      .controls { flex-direction:column; align-items:stretch; }
      .request-table { font-size:.8rem; }
      .request-table th, .request-table td { padding:.5rem; }
    }
  </style>
</head>
<body>
  <header role="banner">
    <div class="brand">
      <span>üìä</span>
      <strong>Loadtest Data</strong>
    </div>
    <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
      <button id="configBtn" type="button" title="Configure Supabase" style="padding:.25rem .5rem;border-radius:4px;border:1px solid var(--color-border);background:var(--color-surface);color:var(--color-text);cursor:pointer;">‚öôÔ∏è Config</button>
      <label for="autoRefresh" style="font-size:.9rem;">Auto Refresh:</label>
      <select id="autoRefresh" style="padding:.25rem .5rem;border-radius:4px;border:1px solid var(--color-border);background:var(--color-surface);color:var(--color-text);">
        <option value="0">Off</option>
        <option value="1000">1s</option>
        <option value="5000">5s</option>
        <option value="10000">10s</option>
        <option value="30000">30s</option>
        <option value="60000">1m</option>
      </select>
      <a href="../../index.html">‚Üê Back to Examples</a>
      <button id="themeToggle" type="button" title="Toggle theme">üåó Theme</button>
    </div>
  </header>

  <!-- Supabase Configuration Modal -->
  <div id="configModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:var(--color-surface);padding:2rem;border-radius:8px;max-width:500px;width:90%;">
      <h2 style="margin-top:0;">Supabase Configuration</h2>
      <div style="margin-bottom:1rem;">
        <label style="display:block;margin-bottom:.5rem;font-weight:600;">Supabase URL</label>
        <input type="text" id="supabaseUrl" placeholder="https://xxxxx.supabase.co" style="width:100%;padding:.5rem;border:1px solid var(--color-border);border-radius:4px;background:var(--color-bg);color:var(--color-text);">
      </div>
      <div style="margin-bottom:1rem;">
        <label style="display:block;margin-bottom:.5rem;font-weight:600;">Supabase Anon Key</label>
        <input type="password" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." style="width:100%;padding:.5rem;border:1px solid var(--color-border);border-radius:4px;background:var(--color-bg);color:var(--color-text);">
      </div>
      <div style="display:flex;gap:.5rem;justify-content:flex-end;">
        <button id="cancelConfig" style="padding:.5rem 1rem;border:1px solid var(--color-border);background:var(--color-surface);color:var(--color-text);border-radius:4px;cursor:pointer;">Cancel</button>
        <button id="saveConfig" style="padding:.5rem 1rem;border:none;background:var(--color-accent);color:white;border-radius:4px;cursor:pointer;">Save</button>
      </div>
    </div>
  </div>

  <main>
    <h1 class="page-title">Loadtest Test Data Results</h1>

    <!-- STATS PANEL -->
    <div class="stats-panel">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Requests</div>
          <div class="stat-value" id="totalRequests">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Unique Parameters</div>
          <div class="stat-value" id="uniqueParams">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Unique Values</div>
          <div class="stat-value" id="uniqueValues">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Duplicate Values</div>
          <div class="stat-value" id="duplicateValues">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Session Start</div>
          <div class="stat-value" id="sessionStart" style="font-size:1rem;">--</div>
        </div>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="stats-panel">
      <div class="controls">
        <button class="btn btn-danger" id="resetBtn">üîÑ Reset Data</button>
        <button class="btn btn-success" id="exportBtn">üì• Export as JSON</button>
      </div>
    </div>

    <!-- REQUEST TABLE -->
    <div class="request-table-section">
      <h2>Request Parameters</h2>
      <div class="table-controls">
        <input type="text" id="requestSearchInput" class="search-input" placeholder="Search parameters or values...">
      </div>
      <div class="table-wrapper">
        <table class="request-table">
          <thead>
            <tr>
              <th class="sortable" data-column="parameter">Parameter</th>
              <th class="sortable" data-column="value">Value</th>
              <th class="sortable" data-column="count">Count</th>
              <th class="sortable" data-column="firstSeen">First Seen</th>
              <th class="sortable" data-column="lastSeen">Last Seen</th>
            </tr>
          </thead>
          <tbody id="requestTableBody">
            <tr>
              <td colspan="5" class="table-empty">No request data yet</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- SESSION DATA TABLE -->
    <div class="request-table-section">
      <h2>Session Data</h2>
      <div class="table-controls">
        <input type="text" id="sessionSearchInput" class="search-input" placeholder="Search session IDs...">
      </div>
      <div class="table-wrapper">
        <table class="request-table">
          <thead>
            <tr>
              <th class="sortable" data-column="sessionId">Session ID</th>
              <th class="sortable" data-column="count">Request Count</th>
            </tr>
          </thead>
          <tbody id="sessionTableBody">
            <tr>
              <td colspan="2" class="table-empty">No session data yet</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="../../theme.js"></script>
  <script>
    // Supabase and Data Store
    const REFRESH_INTERVAL_KEY = 'loadtest-refresh-interval';
    const SESSION_ID_KEY = 'loadtest-session-id';
    
    let supabase = null;
    let supabaseConfig = {
      url: '',
      key: '',
      enabled: false
    };
    
    let requestData = {
      totalRequests: 0,
      sessionStart: null,
      parameters: {},
      sessions: {}
      // Structure for parameters: { paramName: { values: { value1: { count: N, firstSeen: timestamp, lastSeen: timestamp } }, totalCount: N } }
      // Structure for sessions: { sessionId: { count: N, firstSeen: timestamp, lastSeen: timestamp, userAgent: string } }
    };
    let refreshIntervalId = null;
    let realtimeChannel = null;
    let currentSessionId = null;

    // Sorting state
    let requestTableSort = { column: null, direction: 'asc' };
    let sessionTableSort = { column: null, direction: 'asc' };

    // Search state
    let requestSearchTerm = '';
    let sessionSearchTerm = '';

    // Get or create session ID
    function getSessionId() {
      // Check URL params first
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('sessionId')) {
        return urlParams.get('sessionId');
      }
      
      // Check localStorage
      let sessionId = localStorage.getItem(SESSION_ID_KEY);
      if (!sessionId) {
        // Generate new session ID
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem(SESSION_ID_KEY, sessionId);
      }
      return sessionId;
    }

    // Initialize Supabase from config file
    function initSupabase() {
      // Check if config is loaded from supabase-config.js
      if (window.SUPABASE_CONFIG) {
        supabaseConfig = {
          url: window.SUPABASE_CONFIG.url,
          key: window.SUPABASE_CONFIG.anonKey,
          enabled: window.SUPABASE_CONFIG.enabled
        };
      }
      
      // Allow localStorage override for manual configuration
      const stored = localStorage.getItem('supabase-config-override');
      if (stored) {
        try {
          const override = JSON.parse(stored);
          if (override.enabled) {
            supabaseConfig = override;
          }
        } catch (e) {
          console.error('Failed to load Supabase config override:', e);
        }
      }
      
      if (supabaseConfig.enabled && supabaseConfig.url && supabaseConfig.key) {
        try {
          supabase = window.supabase.createClient(supabaseConfig.url, supabaseConfig.key);
          setupRealtimeSubscription();
          console.log('Supabase initialized');
        } catch (e) {
          console.error('Failed to initialize Supabase:', e);
          supabase = null;
        }
      }
    }

    // Setup real-time subscription for auto-updates
    function setupRealtimeSubscription() {
      if (!supabase) return;
      
      realtimeChannel = supabase
        .channel('request_updates')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'request_counts' },
          () => {
            loadData();
            renderData();
          }
        )
        .subscribe();
    }

    // Initialize
    async function init() {
      currentSessionId = getSessionId();
      initSupabase();
      loadConfigUI();
      await loadData();
      loadRefreshInterval();
      await processCurrentRequest();
      renderData();
      setupEventListeners();
      setupAutoRefresh();
    }

    // Load persisted data
    async function loadData() {
      if (supabase && supabaseConfig.enabled) {
        await loadDataFromSupabase();
      }
    }

    // Load from Supabase
    async function loadDataFromSupabase() {
      try {
        // Load request counts
        const { data: counts, error: countsError } = await supabase
          .from('request_counts')
          .select('*')
          .order('parameter_name')
          .order('count', { ascending: false });
        
        if (countsError) {
          console.error('Counts error:', countsError);
          return;
        }
        
        // Load sessions
        const { data: sessions, error: sessionsError } = await supabase
          .from('sessions')
          .select('*')
          .order('count', { ascending: false });
        
        if (sessionsError) {
          console.error('Sessions error:', sessionsError);
        }
        
        requestData.parameters = {};
        requestData.sessions = {};
        requestData.totalRequests = 0;
        
        if (counts && counts.length) {
          // Find earliest first_seen as session start
          let earliestSeen = null;
          
          counts.forEach(row => {
            const { parameter_name, parameter_value, count, first_seen, last_seen } = row;
            
            // Track earliest timestamp for session start
            if (!earliestSeen || first_seen < earliestSeen) {
              earliestSeen = first_seen;
            }
            
            if (!requestData.parameters[parameter_name]) {
              requestData.parameters[parameter_name] = {
                values: {},
                totalCount: 0
              };
            }
            
            requestData.parameters[parameter_name].values[parameter_value] = {
              count: count,
              firstSeen: first_seen,
              lastSeen: last_seen
            };
            requestData.parameters[parameter_name].totalCount += count;
          });
          
          requestData.sessionStart = earliestSeen;
        } else {
          requestData.sessionStart = new Date().toISOString();
        }
        
        // Load session data and calculate total requests
        if (sessions && sessions.length) {
          sessions.forEach(row => {
            requestData.sessions[row.session_id] = {
              count: row.count,
              firstSeen: row.first_seen,
              lastSeen: row.last_seen,
              userAgent: row.user_agent
            };
            // Total requests = sum of all session counts (each session tracks actual page visits)
            requestData.totalRequests += row.count;
          });
        }
      } catch (error) {
        console.error('Failed to load data from Supabase:', error);
      }
    }

    // Process current page request
    async function processCurrentRequest() {
      const urlParams = new URLSearchParams(window.location.search);
      
      if (supabase && supabaseConfig.enabled) {
        const now = new Date().toISOString();
        
        // Always track session, even without URL params
        if (!urlParams.toString()) {
          await trackSession(now);
        } else {
          // Process both session and parameters
          await processRequestToSupabase(urlParams, now);
        }
      }
    }
    
    // Track session only (used when no URL params)
    async function trackSession(now) {
      try {
        const sessionId = currentSessionId;
        const userAgent = navigator.userAgent;
        
        const { data: existingSession, error: sessionSelectError } = await supabase
          .from('sessions')
          .select('count, first_seen')
          .eq('session_id', sessionId)
          .maybeSingle();
        
        if (sessionSelectError) {
          console.error('Session select error:', sessionSelectError);
          return;
        }
        
        if (existingSession) {
          const { error: updateError } = await supabase
            .from('sessions')
            .update({
              count: existingSession.count + 1,
              last_seen: now
            })
            .eq('session_id', sessionId);
          
          if (updateError) {
            console.error('Session update error:', updateError);
          }
        } else {
          const { error: insertError } = await supabase
            .from('sessions')
            .insert({
              session_id: sessionId,
              count: 1,
              first_seen: now,
              last_seen: now,
              user_agent: userAgent
            });
          
          if (insertError) {
            console.error('Session insert error:', insertError);
          }
        }
        
        await loadData();
      } catch (error) {
        console.error('Failed to track session:', error);
      }
    }

    // Process request to Supabase
    async function processRequestToSupabase(urlParams, now) {
      try {
        // Track session
        const sessionId = currentSessionId;
        const userAgent = navigator.userAgent;
        
        // Update session count
        const { data: existingSession, error: sessionSelectError } = await supabase
          .from('sessions')
          .select('count, first_seen')
          .eq('session_id', sessionId)
          .maybeSingle();
        
        if (sessionSelectError) {
          console.error('Session select error:', sessionSelectError);
        }
        
        if (existingSession) {
          const { error: updateError } = await supabase
            .from('sessions')
            .update({
              count: existingSession.count + 1,
              last_seen: now
            })
            .eq('session_id', sessionId);
          
          if (updateError) {
            console.error('Session update error:', updateError);
          }
        } else {
          const { error: insertError } = await supabase
            .from('sessions')
            .insert({
              session_id: sessionId,
              count: 1,
              first_seen: now,
              last_seen: now,
              user_agent: userAgent
            });
          
          if (insertError) {
            console.error('Session insert error:', insertError);
          }
        }
        
        // Track parameters
        for (const [key, value] of urlParams.entries()) {
          // Check if this parameter-value combination exists
          const { data: existing, error: selectError } = await supabase
            .from('request_counts')
            .select('count, first_seen')
            .eq('parameter_name', key)
            .eq('parameter_value', value)
            .maybeSingle();
          
          if (selectError) {
            console.error('Select error:', selectError);
            continue;
          }
          
          if (existing) {
            // Update existing record - increment count and update last_seen
            const { error: updateError } = await supabase
              .from('request_counts')
              .update({
                count: existing.count + 1,
                last_seen: now
              })
              .eq('parameter_name', key)
              .eq('parameter_value', value);
            
            if (updateError) {
              console.error('Update error:', updateError);
            }
          } else {
            // Insert new record
            const { error: insertError } = await supabase
              .from('request_counts')
              .insert({
                parameter_name: key,
                parameter_value: value,
                count: 1,
                first_seen: now,
                last_seen: now
              });
            
            if (insertError) {
              console.error('Insert error:', insertError);
            }
          }
        }
        
        await loadData();
      } catch (error) {
        console.error('Failed to process request to Supabase:', error);
      }
    }

    // Render all data
    function renderData() {
      updateStats();
      renderRequestTable();
      renderSessionTable();
    }

    // Render request table
    function renderRequestTable() {
      const tbody = document.getElementById('requestTableBody');
      const paramKeys = Object.keys(requestData.parameters);
      
      if (paramKeys.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="table-empty">No request data yet</td></tr>';
        return;
      }
      
      // Build flat array for sorting/filtering
      const rows = [];
      paramKeys.forEach(paramName => {
        const param = requestData.parameters[paramName];
        const values = param.values;
        
        Object.keys(values).forEach(value => {
          const valueData = values[value];
          const count = typeof valueData === 'number' ? valueData : valueData.count;
          const firstSeen = typeof valueData === 'number' ? null : new Date(valueData.firstSeen);
          const lastSeen = typeof valueData === 'number' ? null : new Date(valueData.lastSeen);
          
          rows.push({
            parameter: paramName,
            value: value,
            count: count,
            firstSeen: firstSeen,
            lastSeen: lastSeen,
            firstSeenDisplay: firstSeen ? firstSeen.toLocaleString() : '--',
            lastSeenDisplay: lastSeen ? lastSeen.toLocaleString() : '--'
          });
        });
      });
      
      // Filter by search term
      const filteredRows = requestSearchTerm 
        ? rows.filter(row => 
            row.parameter.toLowerCase().includes(requestSearchTerm.toLowerCase()) ||
            row.value.toLowerCase().includes(requestSearchTerm.toLowerCase())
          )
        : rows;
      
      // Sort if column selected
      if (requestTableSort.column) {
        filteredRows.sort((a, b) => {
          let valA = a[requestTableSort.column];
          let valB = b[requestTableSort.column];
          
          // Handle dates
          if (requestTableSort.column === 'firstSeen' || requestTableSort.column === 'lastSeen') {
            valA = valA ? valA.getTime() : 0;
            valB = valB ? valB.getTime() : 0;
          }
          
          // Handle strings vs numbers
          if (typeof valA === 'string') {
            valA = valA.toLowerCase();
            valB = valB.toLowerCase();
          }
          
          if (valA < valB) return requestTableSort.direction === 'asc' ? -1 : 1;
          if (valA > valB) return requestTableSort.direction === 'asc' ? 1 : -1;
          return 0;
        });
      } else {
        // Default sort: by parameter name, then count descending
        filteredRows.sort((a, b) => {
          if (a.parameter < b.parameter) return -1;
          if (a.parameter > b.parameter) return 1;
          return b.count - a.count;
        });
      }
      
      // Render rows
      tbody.innerHTML = filteredRows.map(row => `
        <tr>
          <td class="param-col">${escapeHtml(row.parameter)}</td>
          <td class="value-col">${escapeHtml(row.value)}</td>
          <td class="count-col">${row.count}</td>
          <td class="param-col">${row.firstSeenDisplay}</td>
          <td class="param-col">${row.lastSeenDisplay}</td>
        </tr>
      `).join('');
      
      // Update sort indicators
      updateSortIndicators('request');
    }

    // Update statistics
    function updateStats() {
      // Ensure requestData exists
      if (!requestData || !requestData.parameters) {
        console.warn('Request data not initialized');
        return;
      }
      
      document.getElementById('totalRequests').textContent = (requestData.totalRequests || 0).toLocaleString();
      document.getElementById('uniqueParams').textContent = Object.keys(requestData.parameters).length;
      
      let totalUniqueValues = 0;
      let duplicateValuesCount = 0;
      
      // Count unique values and duplicates
      Object.values(requestData.parameters).forEach(param => {
        if (param && param.values) {
          const valueCount = Object.keys(param.values).length;
          totalUniqueValues += valueCount;
          
          // Count how many parameter-value combinations have been seen more than once
          Object.values(param.values).forEach(valueData => {
            const count = typeof valueData === 'number' ? valueData : valueData.count;
            if (count > 1) {
              duplicateValuesCount++;
            }
          });
        }
      });
      
      document.getElementById('uniqueValues').textContent = totalUniqueValues;
      document.getElementById('duplicateValues').textContent = duplicateValuesCount;
      
      if (requestData.sessionStart) {
        const startDate = new Date(requestData.sessionStart);
        document.getElementById('sessionStart').textContent = startDate.toLocaleString();
      }
    }

    // Render session table
    function renderSessionTable() {
      const tbody = document.getElementById('sessionTableBody');
      
      // Check if we have session data
      if (!requestData.sessions || Object.keys(requestData.sessions).length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="table-empty">No session data yet</td></tr>';
        return;
      }
      
      // Get all sessions
      let sessions = Object.entries(requestData.sessions)
        .map(([sessionId, data]) => ({
          sessionId: sessionId,
          count: data.count,
          userAgent: data.userAgent || 'Unknown'
        }));
      
      // Filter by search term
      if (sessionSearchTerm) {
        sessions = sessions.filter(s => 
          s.sessionId.toLowerCase().includes(sessionSearchTerm.toLowerCase())
        );
      }
      
      // Sort if column selected
      if (sessionTableSort.column) {
        sessions.sort((a, b) => {
          let valA = a[sessionTableSort.column];
          let valB = b[sessionTableSort.column];
          
          if (typeof valA === 'string') {
            valA = valA.toLowerCase();
            valB = valB.toLowerCase();
          }
          
          if (valA < valB) return sessionTableSort.direction === 'asc' ? -1 : 1;
          if (valA > valB) return sessionTableSort.direction === 'asc' ? 1 : -1;
          return 0;
        });
      } else {
        // Default sort: by count descending
        sessions.sort((a, b) => b.count - a.count);
      }
      
      tbody.innerHTML = sessions.map(session => `
        <tr>
          <td title="${escapeHtml(session.userAgent)}">${escapeHtml(session.sessionId)}</td>
          <td>${session.count.toLocaleString()}</td>
        </tr>
      `).join('');
      
      // Update sort indicators
      updateSortIndicators('session');
    }

    // Escape HTML
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Update sort indicators on table headers
    function updateSortIndicators(tableType) {
      const table = tableType === 'request' 
        ? document.querySelector('.request-table-section .request-table')
        : document.querySelectorAll('.request-table-section .request-table')[1];
      
      const sortState = tableType === 'request' ? requestTableSort : sessionTableSort;
      
      // Remove all sort classes
      table.querySelectorAll('th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
      });
      
      // Add sort class to active column
      if (sortState.column) {
        const th = table.querySelector(`th[data-column="${sortState.column}"]`);
        if (th) {
          th.classList.add(sortState.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      }
    }

    // Handle table header click for sorting
    function handleSort(tableType, column) {
      const sortState = tableType === 'request' ? requestTableSort : sessionTableSort;
      
      // Toggle direction if same column, otherwise default to ascending
      if (sortState.column === column) {
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
      } else {
        sortState.column = column;
        sortState.direction = 'asc';
      }
      
      // Re-render table
      if (tableType === 'request') {
        renderRequestTable();
      } else {
        renderSessionTable();
      }
    }

    // Handle search input
    function handleSearch(tableType, searchTerm) {
      if (tableType === 'request') {
        requestSearchTerm = searchTerm;
        renderRequestTable();
      } else {
        sessionSearchTerm = searchTerm;
        renderSessionTable();
      }
    }

    // Export data as JSON
    function exportDataAsJSON() {
      const exportData = {
        exportDate: new Date().toISOString(),
        sessionId: currentSessionId,
        stats: {
          totalRequests: requestData.totalRequests,
          sessionStart: requestData.sessionStart,
          uniqueParameters: Object.keys(requestData.parameters).length,
          uniqueValues: Object.values(requestData.parameters).reduce((sum, param) => 
            sum + Object.keys(param.values).length, 0),
        },
        parameters: requestData.parameters,
        sessions: requestData.sessions
      };
      
      const jsonString = JSON.stringify(exportData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      const filename = `loadtest-data-${new Date().toISOString().split('T')[0]}.json`;
      link.download = filename;
      link.click();
      
      URL.revokeObjectURL(url);
    }

    // Reset data
    async function resetData() {
      if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
        if (supabase && supabaseConfig.enabled) {
          try {
            // Delete all request counts
            await supabase.from('request_counts').delete().neq('parameter_name', '___NONE___');
            
            // Delete all sessions
            await supabase.from('sessions').delete().neq('session_id', '___NONE___');
            
            await loadData();
            renderData();
          } catch (error) {
            console.error('Failed to reset Supabase data:', error);
          }
        }
      }
    }

    // Event listeners
    function setupEventListeners() {
      // Buttons
      document.getElementById('resetBtn').addEventListener('click', resetData);
      document.getElementById('exportBtn').addEventListener('click', exportDataAsJSON);
      document.getElementById('autoRefresh').addEventListener('change', handleRefreshChange);
      document.getElementById('configBtn').addEventListener('click', openConfigModal);
      document.getElementById('saveConfig').addEventListener('click', saveConfigModal);
      document.getElementById('cancelConfig').addEventListener('click', closeConfigModal);
      
      // Search inputs
      const requestSearchInput = document.getElementById('requestSearchInput');
      const sessionSearchInput = document.getElementById('sessionSearchInput');
      
      let requestSearchTimeout;
      requestSearchInput.addEventListener('input', (e) => {
        clearTimeout(requestSearchTimeout);
        requestSearchTimeout = setTimeout(() => {
          handleSearch('request', e.target.value);
        }, 300);
      });
      
      let sessionSearchTimeout;
      sessionSearchInput.addEventListener('input', (e) => {
        clearTimeout(sessionSearchTimeout);
        sessionSearchTimeout = setTimeout(() => {
          handleSearch('session', e.target.value);
        }, 300);
      });
      
      // Table sorting - request table
      document.querySelectorAll('.request-table-section .request-table th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const column = th.getAttribute('data-column');
          handleSort('request', column);
        });
      });
      
      // Table sorting - session table
      document.querySelectorAll('.request-table-section:last-of-type .request-table th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const column = th.getAttribute('data-column');
          handleSort('session', column);
        });
      });
      
      // Close modal on background click
      document.getElementById('configModal').addEventListener('click', (e) => {
        if (e.target.id === 'configModal') closeConfigModal();
      });
    }

    // Config modal functions
    function loadConfigUI() {
      document.getElementById('supabaseUrl').value = supabaseConfig.url || '';
      document.getElementById('supabaseKey').value = supabaseConfig.key || '';
    }

    function openConfigModal() {
      loadConfigUI();
      document.getElementById('configModal').style.display = 'flex';
    }

    function closeConfigModal() {
      document.getElementById('configModal').style.display = 'none';
    }

    function saveConfigModal() {
      const newConfig = {
        url: document.getElementById('supabaseUrl').value.trim(),
        key: document.getElementById('supabaseKey').value.trim(),
        enabled: true
      };
      
      // Save as override in localStorage (takes precedence over config file)
      localStorage.setItem('supabase-config-override', JSON.stringify(newConfig));
      
      supabaseConfig = newConfig;
      
      // Reinitialize Supabase
      if (realtimeChannel) {
        realtimeChannel.unsubscribe();
        realtimeChannel = null;
      }
      supabase = null;
      initSupabase();
      
      closeConfigModal();
      
      // Reload data
      loadData().then(() => renderData());
      
      alert('Configuration saved!\n\nNote: To make this permanent across deployments, update supabase-config.js in the repository.');
    }

    // Auto-refresh functionality
    function loadRefreshInterval() {
      const saved = localStorage.getItem(REFRESH_INTERVAL_KEY);
      if (saved) {
        document.getElementById('autoRefresh').value = saved;
      }
    }

    function setupAutoRefresh() {
      const interval = parseInt(document.getElementById('autoRefresh').value);
      if (interval > 0) {
        startAutoRefresh(interval);
      }
    }

    function handleRefreshChange(event) {
      const interval = parseInt(event.target.value);
      localStorage.setItem(REFRESH_INTERVAL_KEY, interval.toString());
      
      // Clear existing interval
      if (refreshIntervalId) {
        clearInterval(refreshIntervalId);
        refreshIntervalId = null;
      }
      
      // Start new interval if not "Off"
      if (interval > 0) {
        startAutoRefresh(interval);
      }
    }

    function startAutoRefresh(interval) {
      refreshIntervalId = setInterval(() => {
        loadData();
        renderData();
      }, interval);
    }

    // Initialize on load
    // Wait for both DOM and Supabase library to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      // DOM is already ready, check if Supabase library is loaded
      if (window.supabase) {
        init();
      } else {
        // Wait for Supabase library to load
        const checkSupabase = setInterval(() => {
          if (window.supabase) {
            clearInterval(checkSupabase);
            init();
          }
        }, 100);
        
        // Timeout after 5 seconds
        setTimeout(() => {
          clearInterval(checkSupabase);
          if (!window.supabase) {
            console.error('Supabase library failed to load after 5 seconds');
            init(); // Still initialize (will work without Supabase)
          }
        }, 5000);
      }
    }
  </script>
</body>
</html>
