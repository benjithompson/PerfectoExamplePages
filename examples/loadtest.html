<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loadtest Data | Performance Testing</title>
  <meta name="description" content="Track and analyze URL parameters and request data for load testing" />
  <script src="./supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../themes/default.css">
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; }
    body { margin:0; font-family:var(--font-sans); background:var(--color-bg); color:var(--color-text); line-height:1.4; min-height:100vh; display:flex; flex-direction:column; }

    /* HEADER */
    header { position:sticky; top:0; z-index:50; backdrop-filter:blur(18px); background:linear-gradient(145deg,var(--color-bg-alt),var(--color-surface) 60%); border-bottom:1px solid var(--color-border); display:flex; flex-wrap:wrap; align-items:center; gap:1rem; padding:.85rem clamp(1rem,3vw,2rem); box-shadow:var(--shadow-xs); }
    .brand { font-weight:600; letter-spacing:.5px; font-size:1rem; display:flex; align-items:center; gap:.55rem; }
    header a, header button { font:inherit; cursor:pointer; border:1px solid var(--color-border); background:var(--color-surface-alt); color:var(--color-text-dim); padding:.55rem .85rem; border-radius:var(--radius-sm); display:inline-flex; align-items:center; gap:.45rem; font-size:.75rem; font-weight:600; letter-spacing:.8px; text-transform:uppercase; text-decoration:none; transition:var(--transition); }
    header a:hover, header button:hover { color:var(--color-text); border-color:var(--color-accent); }

    /* LAYOUT */
    main { flex:1; width:100%; max-width:1400px; margin:0 auto; padding:1.6rem clamp(1rem,3vw,2.4rem) 3.5rem; }
    .page-title { margin:0 0 1.5rem 0; font-size:clamp(1.9rem,3.5vw,2.8rem); line-height:1.1; letter-spacing:.5px; font-weight:600; background:linear-gradient(92deg,var(--color-text) 10%, var(--color-accent) 95%); -webkit-background-clip:text; background-clip:text; color:transparent; }

    /* STATS PANEL */
    .stats-panel { background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-lg); padding:1.5rem; box-shadow:var(--shadow-md); margin-bottom:1.5rem; }
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-bottom:1.5rem; }
    .stat-card { background:var(--color-bg-alt); border:1px solid var(--color-border); border-radius:var(--radius); padding:1rem; }
    .stat-label { font-size:.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--color-text-dim); margin-bottom:.5rem; font-weight:600; }
    .stat-value { font-size:1.8rem; font-weight:700; color:var(--color-accent); }

    /* REQUEST TABLE */
    .request-table-section { background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-lg); padding:1.5rem; box-shadow:var(--shadow-md); margin-bottom:1.5rem; }
    .request-table-section h2 { margin:0 0 1rem 0; font-size:1.3rem; font-weight:700; }
    .request-table { width:100%; border-collapse:collapse; }
    .request-table thead { background:var(--color-bg-alt); }
    .request-table th { text-align:left; padding:.75rem 1rem; font-size:.75rem; text-transform:uppercase; letter-spacing:1px; color:var(--color-text-dim); font-weight:600; border-bottom:2px solid var(--color-border); }
    .request-table td { padding:.75rem 1rem; border-bottom:1px solid var(--color-border); font-family:monospace; font-size:.9rem; }
    .request-table tbody tr:hover { background:var(--color-bg-alt); }
    .request-table tbody tr:last-child td { border-bottom:none; }
    .param-col { color:var(--color-accent); font-weight:600; }
    .value-col { color:var(--color-text); }
    .count-col { text-align:center; font-weight:700; color:var(--color-accent); }
    .table-empty { text-align:center; padding:2rem; color:var(--color-text-dim); font-style:italic; }

    /* CONTROLS */
    .controls { display:flex; gap:1rem; align-items:center; padding-bottom:1.5rem; border-bottom:2px solid var(--color-border); }
    .btn { font:inherit; cursor:pointer; border:1px solid var(--color-border); background:var(--color-surface-alt); color:var(--color-text); padding:.75rem 1.25rem; border-radius:var(--radius-sm); font-size:.85rem; font-weight:600; letter-spacing:.5px; text-transform:uppercase; transition:var(--transition); display:inline-flex; align-items:center; gap:.5rem; }
    .btn:hover { background:var(--color-accent); color:#fff; border-color:var(--color-accent); }
    .btn-danger { background:#e74c3c; color:#fff; border-color:#e74c3c; }
    .btn-danger:hover { background:#c0392b; border-color:#c0392b; }

    /* PARAMETER GROUPS */
    .param-section { margin-top:1.5rem; }
    .param-group { background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-lg); padding:1.5rem; box-shadow:var(--shadow-md); margin-bottom:1.5rem; }
    .param-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; padding-bottom:.75rem; border-bottom:2px solid var(--color-border); }
    .param-name { font-size:1.2rem; font-weight:700; color:var(--color-text); display:flex; align-items:center; gap:.5rem; }
    .param-count { font-size:.85rem; font-weight:600; background:var(--color-accent); color:#fff; padding:.35rem .75rem; border-radius:20px; }
    
    .value-list { display:flex; flex-direction:column; gap:.75rem; }
    .value-item { display:flex; align-items:center; justify-content:space-between; padding:1rem; background:var(--color-bg-alt); border:1px solid var(--color-border); border-radius:var(--radius); transition:var(--transition); }
    .value-item:hover { border-color:var(--color-accent); box-shadow:var(--shadow-sm); }
    .value-text { font-family:monospace; font-size:.9rem; font-weight:500; color:var(--color-text); flex:1; word-break:break-all; }
    .value-count { display:flex; align-items:center; gap:.5rem; }
    .count-badge { font-size:.9rem; font-weight:700; background:var(--color-surface); border:2px solid var(--color-accent); color:var(--color-accent); padding:.4rem .85rem; border-radius:var(--radius-sm); min-width:60px; text-align:center; }

    .empty-state { text-align:center; padding:3rem 2rem; color:var(--color-text-dim); }
    .empty-icon { font-size:4rem; margin-bottom:1rem; opacity:0.5; }
    .empty-text { font-size:1.1rem; font-weight:600; margin-bottom:.5rem; }
    .empty-hint { font-size:.9rem; opacity:0.8; }

    @media (max-width:768px) {
      .stats-grid { grid-template-columns:1fr; }
      .controls { flex-direction:column; align-items:stretch; }
      .param-header { flex-direction:column; align-items:flex-start; gap:.5rem; }
      .request-table { font-size:.8rem; }
      .request-table th, .request-table td { padding:.5rem; }
    }
  </style>
</head>
<body>
  <header role="banner">
    <div class="brand">
      <span>üìä</span>
      <strong>Loadtest Data</strong>
    </div>
    <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
      <button id="configBtn" type="button" title="Configure Supabase" style="padding:.25rem .5rem;border-radius:4px;border:1px solid var(--color-border);background:var(--color-surface);color:var(--color-text);cursor:pointer;">‚öôÔ∏è Config</button>
      <label for="autoRefresh" style="font-size:.9rem;">Auto Refresh:</label>
      <select id="autoRefresh" style="padding:.25rem .5rem;border-radius:4px;border:1px solid var(--color-border);background:var(--color-surface);color:var(--color-text);">
        <option value="0">Off</option>
        <option value="1000">1s</option>
        <option value="5000">5s</option>
        <option value="10000">10s</option>
        <option value="30000">30s</option>
        <option value="60000">1m</option>
      </select>
      <a href="../index.html">‚Üê Back to Examples</a>
      <button id="themeToggle" type="button" title="Toggle theme">üåó Theme</button>
    </div>
  </header>

  <!-- Supabase Configuration Modal -->
  <div id="configModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:var(--color-surface);padding:2rem;border-radius:8px;max-width:500px;width:90%;">
      <h2 style="margin-top:0;">Supabase Configuration</h2>
      <div style="margin-bottom:1rem;">
        <label style="display:block;margin-bottom:.5rem;font-weight:600;">Supabase URL</label>
        <input type="text" id="supabaseUrl" placeholder="https://xxxxx.supabase.co" style="width:100%;padding:.5rem;border:1px solid var(--color-border);border-radius:4px;background:var(--color-bg);color:var(--color-text);">
      </div>
      <div style="margin-bottom:1rem;">
        <label style="display:block;margin-bottom:.5rem;font-weight:600;">Supabase Anon Key</label>
        <input type="password" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." style="width:100%;padding:.5rem;border:1px solid var(--color-border);border-radius:4px;background:var(--color-bg);color:var(--color-text);">
      </div>
      <div style="margin-bottom:1rem;">
        <label style="display:flex;align-items:center;gap:.5rem;">
          <input type="checkbox" id="useSupabase">
          <span>Enable Supabase (fallback to localStorage if disabled)</span>
        </label>
      </div>
      <div style="display:flex;gap:.5rem;justify-content:flex-end;">
        <button id="cancelConfig" style="padding:.5rem 1rem;border:1px solid var(--color-border);background:var(--color-surface);color:var(--color-text);border-radius:4px;cursor:pointer;">Cancel</button>
        <button id="saveConfig" style="padding:.5rem 1rem;border:none;background:var(--color-accent);color:white;border-radius:4px;cursor:pointer;">Save</button>
      </div>
    </div>
  </div>

  <main>
    <h1 class="page-title">Loadtest Test Data Results</h1>

    <!-- STATS PANEL -->
    <div class="stats-panel">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Requests</div>
          <div class="stat-value" id="totalRequests">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Unique Parameters</div>
          <div class="stat-value" id="uniqueParams">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Unique Values</div>
          <div class="stat-value" id="uniqueValues">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Duplicate Values</div>
          <div class="stat-value" id="duplicateValues">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Session Start</div>
          <div class="stat-value" id="sessionStart" style="font-size:1rem;">--</div>
        </div>
      </div>
    </div>

    <!-- REQUEST TABLE -->
    <div class="request-table-section">
      <h2>Request Parameters</h2>
      <table class="request-table">
        <thead>
          <tr>
            <th>Parameter</th>
            <th>Value</th>
            <th>Count</th>
            <th>First Seen</th>
            <th>Last Seen</th>
          </tr>
        </thead>
        <tbody id="requestTableBody">
          <tr>
            <td colspan="5" class="table-empty">No request data yet</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- CONTROLS -->
    <div class="stats-panel">
      <div class="controls">
        <button class="btn btn-danger" id="resetBtn">üîÑ Reset Data</button>
        <button class="btn" id="exportBtn">üì• Export JSON</button>
      </div>
    </div>

    <!-- CLIENT INFO -->
    <div class="client-info" style="display:none;">
      <h2>Client Information</h2>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Origin</div>
          <div class="info-value" id="clientOrigin">--</div>
        </div>
        <div class="info-item">
          <div class="info-label">User Agent</div>
          <div class="info-value" id="clientUserAgent">--</div>
        </div>
        <div class="info-item">
          <div class="info-label">Referrer</div>
          <div class="info-value" id="clientReferrer">--</div>
        </div>
        <div class="info-item">
          <div class="info-label">Language</div>
          <div class="info-value" id="clientLanguage">--</div>
        </div>
        <div class="info-item">
          <div class="info-label">Screen Resolution</div>
          <div class="info-value" id="clientScreen">--</div>
        </div>
        <div class="info-item">
          <div class="info-label">Current URL</div>
          <div class="info-value" id="clientUrl">--</div>
        </div>
      </div>
    </div>

    <!-- PARAMETER GROUPS -->
    <div class="param-section">
      <div id="paramContainer"></div>
      <div id="emptyState" class="empty-state">
        <div class="empty-icon">üìã</div>
        <div class="empty-text">No URL Parameters Detected</div>
        <div class="empty-hint">Add parameters to the URL to start tracking (e.g., ?user=test&session=123)</div>
      </div>
    </div>
  </main>

  <script src="../theme.js"></script>
  <script>
    // Supabase and Data Store
    const STORAGE_KEY = 'loadtest-data';
    const REFRESH_INTERVAL_KEY = 'loadtest-refresh-interval';
    
    let supabase = null;
    let supabaseConfig = {
      url: '',
      key: '',
      enabled: false
    };
    
    let requestData = {
      totalRequests: 0,
      sessionStart: null,
      parameters: {}
      // Structure: { paramName: { values: { value1: { count: N, firstSeen: timestamp, lastSeen: timestamp } }, totalCount: N } }
    };
    let refreshIntervalId = null;
    let realtimeChannel = null;

    // Initialize Supabase from config file
    function initSupabase() {
      // Check if config is loaded from supabase-config.js
      if (window.SUPABASE_CONFIG) {
        supabaseConfig = {
          url: window.SUPABASE_CONFIG.url,
          key: window.SUPABASE_CONFIG.anonKey,
          enabled: window.SUPABASE_CONFIG.enabled
        };
      }
      
      // Allow localStorage override for manual configuration
      const stored = localStorage.getItem('supabase-config-override');
      if (stored) {
        try {
          const override = JSON.parse(stored);
          if (override.enabled) {
            supabaseConfig = override;
          }
        } catch (e) {
          console.error('Failed to load Supabase config override:', e);
        }
      }
      
      if (supabaseConfig.enabled && supabaseConfig.url && supabaseConfig.key) {
        try {
          supabase = window.supabase.createClient(supabaseConfig.url, supabaseConfig.key);
          setupRealtimeSubscription();
          console.log('Supabase initialized');
        } catch (e) {
          console.error('Failed to initialize Supabase:', e);
          supabase = null;
        }
      }
    }

    // Setup real-time subscription for auto-updates
    function setupRealtimeSubscription() {
      if (!supabase) return;
      
      realtimeChannel = supabase
        .channel('request_updates')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'request_counts' },
          (payload) => {
            console.log('Real-time update:', payload);
            loadData();
            renderData();
          }
        )
        .subscribe();
    }

    // Initialize
    function init() {
      initSupabase();
      loadConfigUI();
      loadData();
      loadRefreshInterval();
      processCurrentRequest();
      renderData();
      setupEventListeners();
      setupAutoRefresh();
    }

    // Load persisted data
    async function loadData() {
      if (supabase && supabaseConfig.enabled) {
        await loadDataFromSupabase();
      } else {
        loadDataFromLocalStorage();
      }
    }

    // Load from Supabase
    async function loadDataFromSupabase() {
      try {
        // Load request counts
        const { data: counts, error: countsError } = await supabase
          .from('request_counts')
          .select('*')
          .order('parameter_name')
          .order('count', { ascending: false });
        
        if (countsError) {
          console.error('Counts error:', countsError);
          return;
        }
        
        requestData.parameters = {};
        requestData.totalRequests = 0;
        
        if (counts && counts.length) {
          // Find earliest first_seen as session start
          let earliestSeen = null;
          
          counts.forEach(row => {
            const { parameter_name, parameter_value, count, first_seen, last_seen } = row;
            
            // Track earliest timestamp for session start
            if (!earliestSeen || first_seen < earliestSeen) {
              earliestSeen = first_seen;
            }
            
            // Sum up total requests
            requestData.totalRequests += count;
            
            if (!requestData.parameters[parameter_name]) {
              requestData.parameters[parameter_name] = {
                values: {},
                totalCount: 0
              };
            }
            
            requestData.parameters[parameter_name].values[parameter_value] = {
              count: count,
              firstSeen: first_seen,
              lastSeen: last_seen
            };
            requestData.parameters[parameter_name].totalCount += count;
          });
          
          requestData.sessionStart = earliestSeen;
        } else {
          requestData.sessionStart = new Date().toISOString();
        }
      } catch (error) {
        console.error('Failed to load data from Supabase:', error);
        // Fallback to localStorage
        loadDataFromLocalStorage();
      }
    }

    // Load from localStorage
    function loadDataFromLocalStorage() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          requestData = JSON.parse(stored);
        } catch (e) {
          console.error('Failed to load stored data:', e);
        }
      }
      if (!requestData.sessionStart) {
        requestData.sessionStart = new Date().toISOString();
      }
    }

    // Save data to localStorage
    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(requestData));
      } catch (e) {
        console.error('Failed to save data:', e);
      }
    }

    // Process current page request
    async function processCurrentRequest() {
      const urlParams = new URLSearchParams(window.location.search);
      
      if (urlParams.toString()) {
        const now = new Date().toISOString();
        
        if (supabase && supabaseConfig.enabled) {
          await processRequestToSupabase(urlParams, now);
        } else {
          processRequestToLocalStorage(urlParams, now);
        }
      }
    }

    // Process request to Supabase
    async function processRequestToSupabase(urlParams, now) {
      try {
        for (const [key, value] of urlParams.entries()) {
          // Check if this parameter-value combination exists
          const { data: existing, error: selectError } = await supabase
            .from('request_counts')
            .select('count, first_seen')
            .eq('parameter_name', key)
            .eq('parameter_value', value)
            .maybeSingle();
          
          if (selectError) {
            console.error('Select error:', selectError);
            continue;
          }
          
          if (existing) {
            // Update existing record - increment count and update last_seen
            const { error: updateError } = await supabase
              .from('request_counts')
              .update({
                count: existing.count + 1,
                last_seen: now
              })
              .eq('parameter_name', key)
              .eq('parameter_value', value);
            
            if (updateError) {
              console.error('Update error:', updateError);
            }
          } else {
            // Insert new record
            const { error: insertError } = await supabase
              .from('request_counts')
              .insert({
                parameter_name: key,
                parameter_value: value,
                count: 1,
                first_seen: now,
                last_seen: now
              });
            
            if (insertError) {
              console.error('Insert error:', insertError);
            }
          }
        }
        
        await loadData();
      } catch (error) {
        console.error('Failed to process request to Supabase:', error);
        // Fallback to localStorage
        processRequestToLocalStorage(urlParams, now);
      }
    }

    // Process request to localStorage
    function processRequestToLocalStorage(urlParams, now) {
      requestData.totalRequests++;
      
      for (const [key, value] of urlParams.entries()) {
        if (key === 'format') continue; // Skip format parameter
        
        if (!requestData.parameters[key]) {
          requestData.parameters[key] = {
            values: {},
            totalCount: 0
          };
        }
        
        if (!requestData.parameters[key].values[value]) {
          requestData.parameters[key].values[value] = {
            count: 0,
            firstSeen: now,
            lastSeen: now
          };
        } else {
          requestData.parameters[key].values[value].lastSeen = now;
        }
        
        requestData.parameters[key].values[value].count++;
        requestData.parameters[key].totalCount++;
      }
      
      saveData();
    }

    // Render all data
    function renderData() {
      updateStats();
      renderRequestTable();
      renderParameters();
    }

    // Render request table
    function renderRequestTable() {
      const tbody = document.getElementById('requestTableBody');
      const paramKeys = Object.keys(requestData.parameters);
      
      if (paramKeys.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="table-empty">No request data yet</td></tr>';
        return;
      }
      
      // Sort parameters by name
      paramKeys.sort();
      
      // Build table rows
      const rows = [];
      paramKeys.forEach(paramName => {
        const param = requestData.parameters[paramName];
        const values = param.values;
        
        // Handle both old format (number) and new format (object with count/firstSeen/lastSeen)
        const valueKeys = Object.keys(values).sort((a, b) => {
          const countA = typeof values[a] === 'number' ? values[a] : values[a].count;
          const countB = typeof values[b] === 'number' ? values[b] : values[b].count;
          return countB - countA;
        });
        
        valueKeys.forEach(value => {
          const valueData = values[value];
          const count = typeof valueData === 'number' ? valueData : valueData.count;
          const firstSeen = typeof valueData === 'number' ? '--' : new Date(valueData.firstSeen).toLocaleString();
          const lastSeen = typeof valueData === 'number' ? '--' : new Date(valueData.lastSeen).toLocaleString();
          
          rows.push(`
            <tr>
              <td class="param-col">${escapeHtml(paramName)}</td>
              <td class="value-col">${escapeHtml(value)}</td>
              <td class="count-col">${count}</td>
              <td class="param-col">${firstSeen}</td>
              <td class="param-col">${lastSeen}</td>
            </tr>
          `);
        });
      });
      
      tbody.innerHTML = rows.join('');
    }

    // Update statistics
    function updateStats() {
      // Ensure requestData exists
      if (!requestData || !requestData.parameters) {
        console.warn('Request data not initialized');
        return;
      }
      
      document.getElementById('totalRequests').textContent = (requestData.totalRequests || 0).toLocaleString();
      document.getElementById('uniqueParams').textContent = Object.keys(requestData.parameters).length;
      
      let totalUniqueValues = 0;
      let duplicateValuesCount = 0;
      
      Object.values(requestData.parameters).forEach(param => {
        if (param && param.values) {
          const valueCount = Object.keys(param.values).length;
          totalUniqueValues += valueCount;
          if (valueCount > 1) {
            duplicateValuesCount++;
          }
        }
      });
      
      document.getElementById('uniqueValues').textContent = totalUniqueValues;
      document.getElementById('duplicateValues').textContent = duplicateValuesCount;
      
      if (requestData.sessionStart) {
        const startDate = new Date(requestData.sessionStart);
        document.getElementById('sessionStart').textContent = startDate.toLocaleString();
      }
    }

    // Render parameter groups
    function renderParameters() {
      const container = document.getElementById('paramContainer');
      const emptyState = document.getElementById('emptyState');
      
      const paramKeys = Object.keys(requestData.parameters);
      
      if (paramKeys.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      // Sort parameters by name
      paramKeys.sort();
      
      container.innerHTML = paramKeys.map(paramName => {
        const param = requestData.parameters[paramName];
        const values = param.values;
        
        // Handle both old format (number) and new format (object with count/firstSeen)
        const valueKeys = Object.keys(values).sort((a, b) => {
          const countA = typeof values[a] === 'number' ? values[a] : values[a].count;
          const countB = typeof values[b] === 'number' ? values[b] : values[b].count;
          return countB - countA;
        });
        
        return `
          <div class="param-group">
            <div class="param-header">
              <div class="param-name">
                <span>üîë</span>
                <code>${escapeHtml(paramName)}</code>
              </div>
              <div class="param-count">${param.totalCount} request${param.totalCount !== 1 ? 's' : ''}</div>
            </div>
            <div class="value-list">
              ${valueKeys.map(value => {
                const valueData = values[value];
                const count = typeof valueData === 'number' ? valueData : valueData.count;
                return `
                <div class="value-item">
                  <div class="value-text">${escapeHtml(value)}</div>
                  <div class="value-count">
                    <div class="count-badge">${count}</div>
                  </div>
                </div>
              `;}).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // Escape HTML
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Reset data
    async function resetData() {
      if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
        if (supabase && supabaseConfig.enabled) {
          try {
            // Delete all request counts
            await supabase.from('request_counts').delete().neq('parameter_name', '___NONE___');
            
            // Reset session
            await supabase
              .from('session')
              .update({
                total_requests: 0,
                start_time: new Date().toISOString()
              })
              .eq('id', 1);
            
            await loadData();
          } catch (error) {
            console.error('Failed to reset Supabase data:', error);
          }
        } else {
          requestData = {
            totalRequests: 0,
            sessionStart: new Date().toISOString(),
            parameters: {}
          };
          saveData();
        }
        renderData();
      }
    }

    // Export data as JSON
    function exportData() {
      const dataStr = JSON.stringify(requestData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `loadtest-data-${Date.now()}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // Event listeners
    function setupEventListeners() {
      document.getElementById('resetBtn').addEventListener('click', resetData);
      document.getElementById('exportBtn').addEventListener('click', exportData);
      document.getElementById('autoRefresh').addEventListener('change', handleRefreshChange);
      document.getElementById('configBtn').addEventListener('click', openConfigModal);
      document.getElementById('saveConfig').addEventListener('click', saveConfigModal);
      document.getElementById('cancelConfig').addEventListener('click', closeConfigModal);
      
      // Close modal on background click
      document.getElementById('configModal').addEventListener('click', (e) => {
        if (e.target.id === 'configModal') closeConfigModal();
      });
    }

    // Config modal functions
    function loadConfigUI() {
      document.getElementById('supabaseUrl').value = supabaseConfig.url || '';
      document.getElementById('supabaseKey').value = supabaseConfig.key || '';
      document.getElementById('useSupabase').checked = supabaseConfig.enabled || false;
    }

    function openConfigModal() {
      loadConfigUI();
      document.getElementById('configModal').style.display = 'flex';
    }

    function closeConfigModal() {
      document.getElementById('configModal').style.display = 'none';
    }

    function saveConfigModal() {
      const newConfig = {
        url: document.getElementById('supabaseUrl').value.trim(),
        key: document.getElementById('supabaseKey').value.trim(),
        enabled: document.getElementById('useSupabase').checked
      };
      
      // Save as override in localStorage (takes precedence over config file)
      localStorage.setItem('supabase-config-override', JSON.stringify(newConfig));
      
      supabaseConfig = newConfig;
      
      // Reinitialize Supabase
      if (realtimeChannel) {
        realtimeChannel.unsubscribe();
        realtimeChannel = null;
      }
      supabase = null;
      initSupabase();
      
      closeConfigModal();
      
      // Reload data
      loadData().then(() => renderData());
      
      alert('Configuration saved! Page will now use ' + (supabaseConfig.enabled ? 'Supabase' : 'localStorage') + '\n\nNote: To make this permanent across deployments, update supabase-config.js in the repository.');
    }

    // Auto-refresh functionality
    function loadRefreshInterval() {
      const saved = localStorage.getItem(REFRESH_INTERVAL_KEY);
      if (saved) {
        document.getElementById('autoRefresh').value = saved;
      }
    }

    function setupAutoRefresh() {
      const interval = parseInt(document.getElementById('autoRefresh').value);
      if (interval > 0) {
        startAutoRefresh(interval);
      }
    }

    function handleRefreshChange(event) {
      const interval = parseInt(event.target.value);
      localStorage.setItem(REFRESH_INTERVAL_KEY, interval.toString());
      
      // Clear existing interval
      if (refreshIntervalId) {
        clearInterval(refreshIntervalId);
        refreshIntervalId = null;
      }
      
      // Start new interval if not "Off"
      if (interval > 0) {
        startAutoRefresh(interval);
      }
    }

    function startAutoRefresh(interval) {
      refreshIntervalId = setInterval(() => {
        loadData();
        renderData();
      }, interval);
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
